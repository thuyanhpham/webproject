<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class=" sizes customelements history pointerevents postmessage webgl websockets cssanimations csscolumns csscolumns-width csscolumns-span csscolumns-fill csscolumns-gap csscolumns-rule csscolumns-rulecolor csscolumns-rulestyle csscolumns-rulewidth csscolumns-breakbefore csscolumns-breakafter csscolumns-breakinside flexbox picture srcset webworkers">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" th:href="@{/css/all.min.css}" />
    <link rel="stylesheet" th:href="@{/css/animate.css}" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/css.css}" />
    <link rel="stylesheet" th:href="@{/css/flaticon.css}" />
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" th:href="@{/css/odometer.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.carousel.min.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.theme.default.min.css}" />
    <link rel="shortcut icon" th:href="@{/images/favicon.png}" type="image/x-icon">
    
	<style>
		.header-button.pr-0 { display: flex; align-items: center; }
         .header-user-greeting { color: #ccc; margin-right: 15px; font-size: 0.9em; }
         .header-user-greeting b { color: #fff; font-weight: 600; }
         .logout-button-form { display: inline-block; margin: 0; padding: 0; vertical-align: middle; }
         .logout-button-styled {
            background: linear-gradient(to right, #e1457a, #8f5ff3); color: #ffffff; padding: 10px 25px; border-radius: 50px; text-transform: uppercase; font-weight: 700; font-size: 14px; letter-spacing: 1px; text-decoration: none; display: inline-block; transition: all 0.3s ease; border: none; cursor: pointer; line-height: normal; text-align: center; vertical-align: middle; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
         }
         .logout-button-styled:hover { opacity: 0.9; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); transform: translateY(-1px); }	
	</style>
    <title th:text="${movie != null ? movie.title + ' - Movie Details' : 'Boleto - Movie Details'}">Boleto - Online Ticket Booking Website HTML Template</title>

</head>
<body>
    <!-- ==========Preloader========== -->
    <div class="preloader" style="display: none;">
        <div class="preloader-inner">
            <div class="preloader-icon">
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
    <!-- ==========Preloader========== -->
    <!-- ==========Overlay========== -->
    <div class="overlay"></div>
    <a href="#0" class="scrollToTop">
        <i class="fas fa-angle-up"></i>
    </a>
    <!-- ==========Overlay========== -->
    <header class="header-section" th:replace="~{fragments/user-header :: header}"></header>
    <!-- ==========Banner-Section========== -->
    <section class="details-banner"
             th:style="${movie != null and movie.bannerUrl != null} ? 'background-image: url(' + @{${movie.bannerUrl}} + ');' : 'background-image: url(' + @{/images/banner02.jpg} + ');'"
             th:attr="data-background=${movie != null and movie.bannerUrl != null ? movie.bannerUrl : './images/banner02.jpg'}">
        <div class="container">
            <div class="details-banner-wrapper" th:if="${movie != null}">
                <div class="details-banner-thumb">
                    <img th:src="${movie.posterUrl != null ? movie.posterUrl : '/images/placeholder.jpg'}" alt="movie poster">
                    <a th:href="${movie.trailerUrl}" class="video-popup" target="_blank">
                        <img th:src="@{/images/video-button.png}" alt="play trailer">
                    </a>
                </div>
                <div class="details-banner-content offset-lg-3">
                    <h3 class="title" th:text="${movie.title}">Movie Title</h3>
                    <div class="tags">
                        <a href="#0" th:text="${movie.language}">Language</a>
                    </div>
					<div class="detail-item">
						    <span class="detail-label">Genres:</span>
						    <span class="detail-value"
						          th:if="${movie.genres != null and not movie.genres.empty}"
						          th:text="${#strings.listJoin(movie.genres.![name], ', ')}">
						    </span>
						    <span class="detail-value" th:unless="${movie.genres != null and not movie.genres.empty}">N/A</span>
						</div>
					<div class="detail-item detail-format">
						     <span class="detail-label">Format:</span>
						     <span class="detail-value"
						           th:if="${movie.format != null and movie.format.name != null}"
						           th:text="${movie.format.name}">
						     </span>
						     <span class="detail-value" th:unless="${movie.format != null and movie.format.name != null}">N/A</span>
						 </div>
                    <div class="social-and-duration">
                        <div class="duration-area">
                            <div class="item">
                                <i class="fas fa-calendar-alt"></i>
                                <span th:if="${movie.releaseDate != null}" th:text="${#temporals.format(movie.releaseDate, 'dd MMM, yyyy')}">Release Date</span>
                            </div>
                            <div class="item">
                                <i class="far fa-clock"></i>
                                <span th:text="${movie.duration != null ? movie.duration + ' mins' : 'N/A'}">Duration</span>
                            </div>
                        </div>
                        <ul class="social-share">
                            <li><a href="#0"><i class="fab fa-facebook-f"></i></a></li>
                            <li><a href="#0"><i class="fab fa-twitter"></i></a></li>
                            <li><a href="#0"><i class="fab fa-pinterest-p"></i></a></li>
                            <li><a href="#0"><i class="fab fa-linkedin-in"></i></a></li>
                            <li><a href="#0"><i class="fab fa-google-plus-g"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="details-banner-wrapper" th:unless="${movie != null}">
                 <h3 style="color: white; text-align: center; padding: 50px;">Movie Not Found!</h3>
            </div>
        </div>
    </section>
    <!-- ==========Banner-Section========== -->
    <!-- ==========Book-Section========== -->
    <section class="book-section bg-one" th:if="${movie != null}">
        <div class="container">
            <div class="book-wrapper offset-lg-3">
                <div class="left-side">
                    <div class="item">
                        <div class="item-header">
                            <div class="thumb"><img th:src="@{/images/tomato2.png}" alt="rating icon"></div>
                            <div class="counter-area"><span class="counter-item odometer odometer-auto-theme" data-odometer-final="88">88</span></div>
                        </div>
                        <p>tomatometer</p>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <div class="thumb"><img th:src="@{/images/cake2.png}" alt="rating icon"></div>
                            <div class="counter-area"><span class="counter-item odometer odometer-auto-theme" data-odometer-final="88">88</span></div>
                        </div>
                        <p>audience Score</p>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <h5 class="title" th:text="${movie.rating != null ? #numbers.formatDecimal(movie.rating, 1, 1) : 'N/A'}">4.5</h5>
                            <div class="rated">
                                <i class="fas fa-heart"></i>
                                <i class="fas fa-heart"></i>
                                <i class="fas fa-heart"></i>
                                <i class="fas fa-heart"></i>
                                <i class="fas fa-heart"></i>
                            </div>
                        </div>
                        <p>Users Rating</p>
                    </div>
                    <div class="item">
                        <div class="item-header">
                            <div class="rated rate-it"> <i class="fas fa-heart"></i> <i class="fas fa-heart"></i> <i class="fas fa-heart"></i> <i class="fas fa-heart"></i> <i class="fas fa-heart"></i> </div>
                            <h5 class="title">0.0</h5>
                        </div>
                        <p><a href="#0">Rate It</a></p>
                    </div>
                </div>
                <a th:href="@{/movies/{movieId}/showtimes(movieId=${movie.id})}" class="custom-button">book tickets</a>
            </div>
        </div>
    </section>
    <!-- ==========Book-Section========== -->
    <!-- ==========Movie-Section========== -->
    <section class="movie-details-section padding-top padding-bottom" th:if="${movie != null}">
        <div class="container">
            <div class="row justify-content-center flex-wrap-reverse mb--50">
                <div class="col-lg-9 mb-50">
                    <div class="movie-details">
                        <div class="tab summery-review">
                            <ul class="tab-menu">
                                <li class="active"> summery </li>
                                <li> user review <span th:text="${reviewPage != null ? reviewPage.totalElements : 0}">0</span> </li>
                            </ul>
                            <div class="tab-area">
                                <div class="tab-item active">
                                    <div class="item">
                                        <h5 class="sub-title">Synopsis</h5>
                                        <p th:text="${movie.description}">Movie description goes here.</p>
                                    </div>
                                    <div class="item">
                                        <div class="header">
                                            <h5 class="sub-title">cast</h5>
                                            <div class="navigation">
                                                <div class="cast-prev"><i class="flaticon-double-right-arrows-angles"></i></div>
                                                <div class="cast-next"><i class="flaticon-double-right-arrows-angles"></i></div>
                                            </div>
                                        </div>
                                        <div class="casting-slider owl-carousel owl-loaded owl-drag">
                                            <div class="owl-stage-outer"><div class="owl-stage">
                                                <th:block th:if="${movie.cast != null and !#strings.isEmpty(movie.cast)}">
												    <div class="owl-item" th:each="actorName : ${#strings.arraySplit(movie.cast, ',')}">
												        <div class="cast-item">
												            <div class="cast-thumb">
												                <a href="javascript:void(0);"><img th:src="@{/images/cast-placeholder.jpg}" alt="cast photo"></a>
												            </div>
												            <div class="cast-content">
												                <h6 class="cast-title"><a href="javascript:void(0);" th:text="${#strings.trim(actorName)}">Actor Name</a></h6>
												                <span class="cate">actor</span>
												            </div>
												        </div>
												    </div>
												</th:block>
												<div class="owl-item" th:if="${movie.cast == null or #strings.isEmpty(movie.cast)}">
												    <p style="padding: 20px; text-align: center;">No cast information available.</p>
												</div>
                                            </div></div>
                                            <div class="owl-nav disabled"><button type="button" role="presentation" class="owl-prev"><span aria-label="Previous">‹</span></button><button type="button" role="presentation" class="owl-next"><span aria-label="Next">›</span></button></div><div class="owl-dots disabled"></div>
                                        </div>
                                    </div>
                                    <div class="item">
										    <h5 class="sub-title">Director</h5>
										    <p th:if="${movie.director != null and !#strings.isEmpty(movie.director)}"
										       th:text="${movie.director}">
										        Director Name
										    </p>
										    <p th:unless="${movie.director != null and !#strings.isEmpty(movie.director)}">
										        N/A
										    </p>
                                    </div>
                                </div>
                                
 								<div class="tab-item" id="user-review-content-area">
						    <div th:if="${movie != null}">
						
						        <div class="movie-review-item" th:each="review : ${reviewsForDisplay}" th:attr="data-review-id=${review.id}">
						            <div class="author">
						                <div class="thumb">
						                    <a href="#0">
						                        <img th:src="${review.user?.avatarUrl != null ? review.user.avatarUrl : '/images/user-placeholder.jpg'}"
						                             alt="user avatar" class="review-user-avatar">
						                    </a>
						                </div>
						                <div class="movie-review-info">
						                    <span class="reply-date" th:if="${review.timestamp != null}"
						                          th:text="${#temporals.format(review.timestamp, 'dd MMM yy HH:mm')}">Review Date</span>
						                    <h6 class="subtitle">
						                        <a href="#0"
						                           th:text="${review.user?.fullname != null ? review.user.fullname : review.user?.username}">User Name</a>
						                    </h6>
						                    <span th:if="${review.verified != null and review.verified}">
						                        <i class="fas fa-check"></i> verified review
						                    </span>
						                </div>
						            </div>
						            <div class="movie-review-content">
						                <div class="review">
						                    <i class="flaticon-favorite-heart-button"
						                       th:each="star : ${#numbers.sequence(1, review.rating != null ? review.rating : 0)}"></i>
						                </div>
						                <h6 class="cont-title" th:text="${review.title}">Review Title</h6>
						                <p th:text="${review.content}">Review content...</p>
						                
						                <div class="review-meta">
						                    <a href="javascript:void(0);" class="review-like-btn" th:attr="data-review-id=${review.id}">
						                        <i class="flaticon-hand"></i><span class="like-count" th:text="${review.likes != null ? review.likes : 0}">0</span>
						                    </a>
						                    <a href="javascript:void(0);" class="review-dislike-btn dislike" th:attr="data-review-id=${review.id}">
						                        <i class="flaticon-dont-like-symbol"></i><span class="dislike-count" th:text="${review.dislikes != null ? review.dislikes : 0}">0</span>
						                    </a>
						                    <a href="javascript:void(0);" class="review-report-btn" 
						                       th:attr="data-review-id=${review.id}, data-review-user=${review.user?.fullname != null ? review.user.fullname : review.user?.username}">
						                       Report Abuse
						                    </a>
						                </div>
						               
						            </div>
						        </div>
						
						        <div id="no-reviews-message" class="movie-review-item" th:if="${#lists.isEmpty(reviewsForDisplay)}">
						            <p>No reviews yet.</p>
						        </div>
						
						        <div id="more-reviews-container">
						            </div>
						
						        <div class="load-more text-center" th:if="${reviewPage != null and reviewPage.hasNext()}">
						            <a href="javascript:void(0);" class="custom-button transparent"
						               id="load-more-reviews-btn"
						               th:attr="data-movie-id=${movie.id}, data-next-page=${reviewPage.number + 1}, data-page-size=${reviewPage.size}">
						                load more
						            </a>
						        </div>
						       
						    </div> <div th:if="${movie == null}">
						        <p>Movie information not available.</p>
						    </div>
						    
						    <div id="reviews-section" class="leave-review-section mt-5 pt-4 border-top" th:if="${movie != null}">
						        <div th:if="${#authorization.expression('isAuthenticated()')}">
						            <h4>Leave a Review for <span th:text="${movie.title}">Movie Title</span></h4>
						            <div th:if="${param.reviewSuccess}" class="alert alert-success" role="alert"
						                 th:text="${param.reviewSuccess[0] == 'true' ? 'Your review has been submitted successfully!' : ''}">
						            </div>
						            <div th:if="${param.reviewError}" class="alert alert-danger" role="alert"
						                 th:text="${param.reviewError[0]}">
						            </div>
						            <div th:if="${reviewSuccessMessage}" class="alert alert-success" role="alert" th:text="${reviewSuccessMessage}"></div>
						            <div th:if="${reviewErrorMessage}" class="alert alert-danger" role="alert" th:text="${reviewErrorMessage}"></div>
						            <form id="reviewForm" th:action="@{/movies/{movieId}/reviews/submit(movieId=${movie.id})}" method="post" class="comment-form mt-3">
						                <div class="form-group row">
						                    <label for="rating" class="col-sm-3 col-form-label">Your Rating <span class="text-danger">*</span>:</label>
						                    <div class="col-sm-9">
						                        <select class="form-control" id="rating" name="rating" required>
						                            <option value="" disabled selected>-- Select Rating --</option>
						                            <option value="5">★★★★★ (Excellent)</option>
						                            <option value="4">★★★★☆ (Good)</option>
						                            <option value="3">★★★☆☆ (Average)</option>
						                            <option value="2">★★☆☆☆ (Fair)</option>
						                            <option value="1">★☆☆☆☆ (Poor)</option>
						                        </select>
						                    </div>
						                </div>
						                <div class="form-group row">
						                    <label for="reviewTitle" class="col-sm-3 col-form-label">Review Title:</label>
						                    <div class="col-sm-9">
						                        <input type="text" class="form-control" id="reviewTitle" name="title" placeholder="e.g., Amazing movie!"
						                               th:value="${submittedTitle}">
						                    </div>
						                </div>
						                <div class="form-group row">
						                    <label for="reviewContent" class="col-sm-3 col-form-label">Your Review <span class="text-danger">*</span>:</label>
						                    <div class="col-sm-9">
						                        <textarea class="form-control" id="reviewContent" name="content" rows="5" placeholder="Share your thoughts..." required
						                                  th:text="${submittedContent}"></textarea>
						                    </div>
						                </div>
						                <div class="form-group row">
						                    <div class="col-sm-9 offset-sm-3">
						                        <button type="submit" class="custom-button btn-primary">Submit Review</button>
						                    </div>
						                </div>
						            </form>
						        </div>
						        <div th:unless="${#authorization.expression('isAuthenticated()')}" class="text-center">
						            <p class="lead">Want to share your thoughts on this movie?</p>
						            <a th:href="@{/login(redirectUrl=${#httpServletRequest.requestURI})}" class="custom-button">Login to Write a Review</a>
						        </div>
						    </div> </div> 

							</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
       
    </section>
    <!-- ==========Movie-Section========== -->

    <!-- ==========Footer Section========== -->
    <footer class="footer-section">
        <!-- Newsletter Section -->
        <div class="newslater-section padding-bottom">
            <div class="container">
                <div class="newslater-container" th:attr="data-background=@{/images/newslater-bg01.jpg}">
                    <div class="newslater-wrapper">
                        <h5 class="cate">subscribe to Boleto </h5>
                        <h3 class="title">to get exclusive benifits</h3>
                        <form class="newslater-form" th:action="@{/subscribe}" method="post">
                            <input type="email" placeholder="Your Email Address" name="email" required>
                            <button type="submit">subscribe</button>
                        </form>
                        <p>We respect your privacy, so we never share your info</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer Content -->
        <div class="container">
            <div class="footer-top">
                <div class="logo"> <a th:href="@{/}"> <img th:src="@{/images/footer-logo.png}" alt="footer logo"> </a> </div>
                 <ul class="social-icons">
                     <li><a href="#0"><i class="fab fa-facebook-f"></i></a></li>
                     <li><a href="#0" class="active"><i class="fab fa-twitter"></i></a></li>
                     <li><a href="#0"><i class="fab fa-pinterest-p"></i></a></li>
                     <li><a href="#0"><i class="fab fa-google"></i></a></li>
                     <li><a href="#0"><i class="fab fa-instagram"></i></a></li>
                 </ul>
            </div>
            <div class="footer-bottom">
                 <div class="footer-bottom-area">
                     <div class="left"> <p>Copyright © <span th:text="${#dates.year(#dates.createNow())}">2024</span>. All Rights Reserved By <a href="#0">Boleto</a></p> </div>
                     <ul class="links">
                         <li><a th:href="@{/about}">About</a></li>
                         <li><a th:href="@{/terms}">Terms Of Use</a></li>
                         <li><a th:href="@{/privacy}">Privacy Policy</a></li>
                         <li><a th:href="@{/faq}">FAQ</a></li>
                         <li><a th:href="@{/feedback}">Feedback</a></li>
                     </ul>
                 </div>
             </div>
        </div>
    </footer>
    <!-- ==========Footer Section========== -->

  	<script th:src="@{/js/jquery-3.3.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/modernizr-3.6.0.min.js}"></script>
    <script th:src="@{/js/plugins.js}"></script>
    <script th:src="@{/js/magnific-popup.min.js}"></script>
    <script th:src="@{/js/nice-select.js}"></script>
    <script th:src="@{/js/odometer.min.js}"></script>
    <script th:src="@{/js/owl.carousel.min.js}"></script>
    <script th:src="@{/js/viewport.js}"></script>
    <script th:src="@{/js/wow.min.js}"></script>
    <script th:src="@{/js/countdown.min.js}"></script>
    <script th:src="@{/js/isotope.pkgd.min.js}"></script>
    <script th:src="@{/js/contentInt.js}"></script>
    <script th:src="@{/js/chunk-7ac80a40.js}"></script>
    <script th:src="@{/js/main.js}"></script>
		
	<script th:inline="javascript">
	/*<![CDATA[*/
	document.addEventListener('DOMContentLoaded', function() {
	    // --- PHẦN VALIDATE FORM REVIEW ---
	    const reviewForm = document.getElementById('reviewForm');
	    if (reviewForm) {
	        reviewForm.addEventListener('submit', function(event) {
	            const ratingSelect = document.getElementById('rating');
	            const contentTextarea = document.getElementById('reviewContent');
	            let isValid = true;
	            clearErrorMessages(this);
	            if (!ratingSelect.value) {
	                isValid = false;
	                displayErrorMessage(ratingSelect, 'Please select a rating.');
	            }
	            if (!contentTextarea.value.trim()) {
	                isValid = false;
	                displayErrorMessage(contentTextarea, 'Please write your review content.');
	            } else if (contentTextarea.value.trim().length < 10) {
	                isValid = false;
	                displayErrorMessage(contentTextarea, 'Review content must be at least 10 characters long.');
	            }
	            if (!isValid) {
	                event.preventDefault();
	            }
	        });
	    }
	
	    function displayErrorMessage(inputElement, message) {
	        const errorDiv = document.createElement('div');
	        errorDiv.className = 'text-danger small mt-1 validation-error-message';
	        errorDiv.textContent = message;
	        inputElement.parentNode.insertBefore(errorDiv, inputElement.nextSibling);
	        inputElement.classList.add('is-invalid');
	    }
	
	    function clearErrorMessages(formElement) {
	        formElement.querySelectorAll('.validation-error-message').forEach(msg => msg.remove());
	        formElement.querySelectorAll('.is-invalid').forEach(input => input.classList.remove('is-invalid'));
	    }
	
	    // --- HÀM TẠO HTML CHO MỘT REVIEW ITEM (CẬP NHẬT CHO REPORT ABUSE) ---
	    function createReviewElement(review) {
	        const reviewItemDiv = document.createElement('div');
	        reviewItemDiv.className = 'movie-review-item';
	        reviewItemDiv.dataset.reviewId = review.id;
	
	        const authorDiv = document.createElement('div');
	        authorDiv.className = 'author';
	        const thumbDiv = document.createElement('div');
	        thumbDiv.className = 'thumb';
	        const authorLink = document.createElement('a');
	        authorLink.href = '#0';
	        const avatarImg = document.createElement('img');
	        avatarImg.src = (review.user && review.user.avatarUrl) ? review.user.avatarUrl : '/images/user-placeholder.jpg';
	        avatarImg.alt = (review.user && (review.user.fullname || review.user.username)) ? (review.user.fullname || review.user.username) + "'s avatar" : 'user avatar';
	        avatarImg.classList.add('review-user-avatar');
	        authorLink.appendChild(avatarImg);
	        thumbDiv.appendChild(authorLink);
	        authorDiv.appendChild(thumbDiv);
	
	        const movieReviewInfoDiv = document.createElement('div');
	        movieReviewInfoDiv.className = 'movie-review-info';
	        if (review.timestamp) {
	            const replyDateSpan = document.createElement('span');
	            replyDateSpan.className = 'reply-date';
	            try {
	                const dateObject = new Date(review.timestamp);
	                if (isNaN(dateObject.getTime())) throw new Error("Invalid date");
	                const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
	                replyDateSpan.textContent = dateObject.toLocaleDateString('en-GB', options).replace(',', '');
	            } catch (e) { replyDateSpan.textContent = "Ngày không hợp lệ"; }
	            movieReviewInfoDiv.appendChild(replyDateSpan);
	        }
	        const subtitleH6 = document.createElement('h6');
	        subtitleH6.className = 'subtitle';
	        const userNameLink = document.createElement('a');
	        userNameLink.href = '#0';
	        let displayName = 'Người dùng ẩn danh';
	        if (review.user) displayName = review.user.fullname || review.user.username || 'Người dùng ẩn danh';
	        userNameLink.textContent = displayName;
	        subtitleH6.appendChild(userNameLink);
	        movieReviewInfoDiv.appendChild(subtitleH6);
	        if (review.verified === true) {
	            const verifiedSpan = document.createElement('span');
	            verifiedSpan.innerHTML = '<i class="fas fa-check"></i> verified review';
	            movieReviewInfoDiv.appendChild(verifiedSpan);
	        }
	        authorDiv.appendChild(movieReviewInfoDiv);
	        reviewItemDiv.appendChild(authorDiv);
	
	        const movieReviewContentDiv = document.createElement('div');
	        movieReviewContentDiv.className = 'movie-review-content';
	        const reviewStarsDiv = document.createElement('div');
	        reviewStarsDiv.className = 'review';
	        const ratingValue = review.rating || 0;
	        for (let i = 1; i <= ratingValue; i++) {
	            const starIcon = document.createElement('i');
	            starIcon.className = 'flaticon-favorite-heart-button';
	            reviewStarsDiv.appendChild(starIcon);
	        }
	        movieReviewContentDiv.appendChild(reviewStarsDiv);
	        if (review.title) {
	            const contTitleH6 = document.createElement('h6');
	            contTitleH6.className = 'cont-title';
	            contTitleH6.textContent = review.title;
	            movieReviewContentDiv.appendChild(contTitleH6);
	        }
	        const contentP = document.createElement('p');
	        contentP.textContent = review.content || '';
	        movieReviewContentDiv.appendChild(contentP);
	
	        const reviewMetaDiv = document.createElement('div');
	        reviewMetaDiv.className = 'review-meta';
	        // Nút Like
	        const likesLink = document.createElement('a');
	        likesLink.href = 'javascript:void(0);';
	        likesLink.className = 'review-like-btn';
	        likesLink.dataset.reviewId = review.id;
	        likesLink.innerHTML = `<i class="flaticon-hand"></i><span class="like-count"> ${review.likes || 0}</span>`;
	        reviewMetaDiv.appendChild(likesLink);
	        // Nút Dislike
	        const dislikesLink = document.createElement('a');
	        dislikesLink.href = 'javascript:void(0);';
	        dislikesLink.className = 'review-dislike-btn dislike';
	        dislikesLink.dataset.reviewId = review.id;
	        dislikesLink.innerHTML = `<i class="flaticon-dont-like-symbol"></i><span class="dislike-count"> ${review.dislikes || 0}</span>`;
	        reviewMetaDiv.appendChild(dislikesLink);
	        // Nút Report Abuse - CẬP NHẬT
	        const reportLink = document.createElement('a');
	        reportLink.href = 'javascript:void(0);';
	        reportLink.className = 'review-report-btn';
	        reportLink.dataset.reviewId = review.id;
	        const reviewUserDisplayName = (review.user && (review.user.fullname || review.user.username)) ? (review.user.fullname || review.user.username) : 'this user';
	        reportLink.dataset.reviewUser = reviewUserDisplayName; 
	        reportLink.textContent = ' Report Abuse ';
	        reviewMetaDiv.appendChild(reportLink);
	
	        movieReviewContentDiv.appendChild(reviewMetaDiv);
	        reviewItemDiv.appendChild(movieReviewContentDiv);
	
	        return reviewItemDiv;
	    }
	
	    // --- PHẦN SCRIPT CHO "LOAD MORE" REVIEWS ---
	    const loadMoreButton = document.getElementById('load-more-reviews-btn');
	    const reviewsContainer = document.getElementById('more-reviews-container');
	    const noReviewsMessage = document.getElementById('no-reviews-message');
	
	    if (loadMoreButton && reviewsContainer) {
	         loadMoreButton.addEventListener('click', function (event) {
	             event.preventDefault();
	             const movieId = this.dataset.movieId;
	             let nextPage = parseInt(this.dataset.nextPage);
	             const pageSize = parseInt(this.dataset.pageSize);
	             this.textContent = 'Loading...';
	             this.disabled = true;
	
	             fetch(`/movies/api/${movieId}/reviews?page=${nextPage}&size=${pageSize}`)
	                 .then(response => {
	                     if (!response.ok) {
	                         return response.text().then(text => { throw new Error(`Lỗi mạng: ${response.status} ${response.statusText}. Phản hồi từ server: ${text}`); });
	                     }
	                     return response.json();
	                 })
	                 .then(pageData => {
	                     if (pageData && pageData.content && pageData.content.length > 0) {
	                         pageData.content.forEach(review => {
	                             const reviewElement = createReviewElement(review);
	                             reviewsContainer.appendChild(reviewElement);
	                         });
	                         nextPage++;
	                         this.dataset.nextPage = nextPage;
	                         if (noReviewsMessage && noReviewsMessage.style.display !== 'none') {
	                         }
	                     }
	                     if (!pageData.last) {
	                         this.textContent = 'Load More';
	                         this.disabled = false;
	                     } else {
	                         this.textContent = 'No More Reviews';
	                         this.disabled = true;
	                     }
	                 })
	                 .catch(error => {
	                     console.error('Error fetching more reviews:', error);
	                     this.textContent = 'Error - Retry';
	                     this.disabled = false;
	                 });
	         });
	    } else {
	        if (!loadMoreButton) console.warn("Load more button ('load-more-reviews-btn') not found.");
	        if (!reviewsContainer) console.warn("Container for more reviews ('more-reviews-container') not found.");
	    }
	
	    // --- PHẦN SCRIPT XỬ LÝ LIKE/DISLIKE ---
	    async function handleReviewVote(reviewId, action, buttonElement) {
	        console.log(`[handleReviewVote] Called for reviewId: ${reviewId}, action: ${action}`);
	        if(buttonElement) buttonElement.disabled = true;
	
	        const csrfTokenElement = document.querySelector('meta[name="_csrf"]');
	        const csrfHeaderNameElement = document.querySelector('meta[name="_csrf_header"]');
	        const csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : null;
	        const csrfHeaderName = csrfHeaderNameElement ? csrfHeaderNameElement.getAttribute('content') : null;
	        const headers = { 'Content-Type': 'application/json' };
	        if (csrfToken && csrfHeaderName) {
	            headers[csrfHeaderName] = csrfToken;
	            console.log(`[handleReviewVote] CSRF Token added: ${csrfHeaderName}`);
	        } else {
	            console.warn("[handleReviewVote] CSRF token or header name not found. POST request might be blocked if CSRF is enabled.");
	        }
	
	        try {
	            const apiUrl = `/movies/api/reviews/${reviewId}/${action}`;
	            console.log(`[handleReviewVote] Fetching: ${apiUrl}`);
	            const response = await fetch(apiUrl, { method: 'POST', headers: headers });
	            console.log(`[handleReviewVote] Response status: ${response.status}`);
	
	            if (!response.ok) {
	                const errorText = await response.text();
	                console.error(`[handleReviewVote] API Error Response Text: ${errorText}`);
	                let errorMessage = `Lỗi HTTP ${response.status}. Không thể ${action} đánh giá.`;
	                try {
	                    const errorData = JSON.parse(errorText);
	                    if (errorData && errorData.error) { errorMessage = errorData.error; }
	                } catch (e) { if(errorText) errorMessage = errorText; }
	                throw new Error(errorMessage);
	            }
	
	            const updatedReviewDTO = await response.json();
	            console.log("[handleReviewVote] Updated Review DTO from server:", updatedReviewDTO);
	
	            const reviewItemElement = document.querySelector(`.movie-review-item[data-review-id="${reviewId}"]`);
	            console.log(`[handleReviewVote] Attempting to find review item with selector: .movie-review-item[data-review-id="${reviewId}"]`);
	            console.log("[handleReviewVote] Found reviewItemElement for UI update:", reviewItemElement);
	
	            if (reviewItemElement) {
	                const likeCountElement = reviewItemElement.querySelector('.like-count');
	                const dislikeCountElement = reviewItemElement.querySelector('.dislike-count');
	                console.log("[handleReviewVote] Found likeCountElement:", likeCountElement);
	                console.log("[handleReviewVote] Found dislikeCountElement:", dislikeCountElement);
	
	                if (likeCountElement && updatedReviewDTO.likes !== null && updatedReviewDTO.likes !== undefined) {
	                    likeCountElement.textContent = ` ${updatedReviewDTO.likes}`;
	                    console.log(`[handleReviewVote] Updated like count to: ${updatedReviewDTO.likes}`);
	                } else {
	                    console.warn("[handleReviewVote] likeCountElement not found or updatedReviewDTO.likes is null/undefined.");
	                }
	
	                if (dislikeCountElement && updatedReviewDTO.dislikes !== null && updatedReviewDTO.dislikes !== undefined) {
	                    dislikeCountElement.textContent = ` ${updatedReviewDTO.dislikes}`;
	                    console.log(`[handleReviewVote] Updated dislike count to: ${updatedReviewDTO.dislikes}`);
	                } else {
	                    console.warn("[handleReviewVote] dislikeCountElement not found or updatedReviewDTO.dislikes is null/undefined.");
	                }
	            } else {
	                console.warn(`[handleReviewVote] Could not find review item element for reviewId: ${reviewId} to update counts.`);
	            }
	        } catch (error) {
	            console.error(`[handleReviewVote] Lỗi trong quá trình ${action} cho review ${reviewId}:`, error);
	            alert(`Không thể ${action} đánh giá. ${error.message}`);
	        } finally {
	             if(buttonElement) buttonElement.disabled = false;
	        }
	    }
	
	    // --- HÀM MỚI XỬ LÝ REPORT ABUSE ---
	    async function handleReviewReport(reviewId, userNameOfReviewedUser, buttonElement) {
	        console.log(`[handleReviewReport] Called for reviewId: ${reviewId}, user of review: ${userNameOfReviewedUser}`);
	
	        const confirmationMessage = `Bạn có chắc chắn muốn báo cáo bình luận của người dùng "${userNameOfReviewedUser}" không?`;
	        if (!confirm(confirmationMessage)) {
	            console.log("[handleReviewReport] User cancelled report.");
	            return;
	        }
	
	        if(buttonElement) {
	            buttonElement.disabled = true;
	            buttonElement.textContent = 'Reporting...';
	        }
	
	        const csrfTokenElement = document.querySelector('meta[name="_csrf"]');
	        const csrfHeaderNameElement = document.querySelector('meta[name="_csrf_header"]');
	        const csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : null;
	        const csrfHeaderName = csrfHeaderNameElement ? csrfHeaderNameElement.getAttribute('content') : null;
	        const headers = { 'Content-Type': 'application/json' };
	        if (csrfToken && csrfHeaderName) {
	            headers[csrfHeaderName] = csrfToken;
	            console.log(`[handleReviewReport] CSRF Token added: ${csrfHeaderName}`);
	        } else {
	            console.warn("[handleReviewReport] CSRF token or header name not found.");
	        }
	
	        try {
	            const apiUrl = `/movies/api/reviews/${reviewId}/report`;
	            console.log(`[handleReviewReport] Fetching: ${apiUrl}`);
	            const response = await fetch(apiUrl, {
	                method: 'POST',
	                headers: headers,
	            });
	            console.log(`[handleReviewReport] Response status: ${response.status}`);
	
	            const resultData = await response.json();
	            console.log("[handleReviewReport] Report Result from server:", resultData);
	
	            if (!response.ok) {
	                throw new Error(resultData.error || `Lỗi HTTP ${response.status}. Không thể báo cáo đánh giá.`);
	            }
	
	            alert(resultData.message || "Thao tác thành công.");
	
	            if (resultData.deleted === true) {
	                console.log(`[handleReviewReport] Review ID: ${reviewId} was deleted.`);
	                const reviewItemElement = document.querySelector(`.movie-review-item[data-review-id="${reviewId}"]`);
	                if (reviewItemElement) {
	                    reviewItemElement.remove();
	                    console.log(`[handleReviewReport] Review element for ID: ${reviewId} removed from UI.`);
	                } else {
	                     console.warn(`[handleReviewReport] Could not find review item element for reviewId: ${reviewId} to remove from UI.`);
	                }
	            } else {

	                if(buttonElement) {
	                    buttonElement.textContent = 'Reported';
	                }
	            }
	
	        } catch (error) {
	            console.error(`[handleReviewReport] Lỗi khi báo cáo review ${reviewId}:`, error);
	            alert(`Không thể báo cáo đánh giá. ${error.message}`);
	            if(buttonElement) {
	                buttonElement.textContent = 'Report Abuse';
	                buttonElement.disabled = false;
	            }
	        }
	    }
	    // Gắn sự kiện click vào container cha của tất cả reviews
	    const reviewsWrapper = document.getElementById('user-review-content-area');
	    console.log("reviewsWrapper (nơi gắn event listener):", reviewsWrapper);
	
	    if (reviewsWrapper) {
	        reviewsWrapper.addEventListener('click', function(event) {
	            const target = event.target;
	            let actionButton = null; 
	            let reportButton = null;
	            let actionType = '';
	
	            // Kiểm tra nút like
	            if (target.matches('.review-like-btn') || target.closest('.review-like-btn')) {
	                actionButton = target.closest('.review-like-btn');
	                actionType = 'like';
	            }
	            // Kiểm tra nút dislike
	            else if (target.matches('.review-dislike-btn') || target.closest('.review-dislike-btn')) {
	                actionButton = target.closest('.review-dislike-btn');
	                actionType = 'dislike';
	            }
	            // Kiểm tra nút report abuse
	            else if (target.matches('.review-report-btn') || target.closest('.review-report-btn')) {
	                reportButton = target.closest('.review-report-btn');
	            }
	
	            // Xử lý cho like/dislike
	            if (actionButton && actionType) {
	                event.preventDefault();
	                const reviewId = actionButton.dataset.reviewId;
	                if (reviewId) {
	                    handleReviewVote(reviewId, actionType, actionButton);
	                } else {
	                    console.error("Không tìm thấy Review ID trên nút like/dislike:", actionButton);
	                }
	            }
	            // Xử lý cho report abuse
	            else if (reportButton) {
	                event.preventDefault();
	                const reviewId = reportButton.dataset.reviewId;
	                const reviewUser = reportButton.dataset.reviewUser || "người dùng này";
	                if (reviewId) {
	                    handleReviewReport(reviewId, reviewUser, reportButton);
	                } else {
	                    console.error("Không tìm thấy Review ID trên nút report:", reportButton);
	                }
	            }
	        });
	    } else {
	        console.warn("Không tìm thấy container cha cho reviews (mong đợi #user-review-content-area) để gắn sự kiện.");
	    }
	});
	/*]]>*/
	</script>
</body>
</html>