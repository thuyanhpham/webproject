<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script th:src="@{/js/jquery-3.3.1.min.js}"></script>

    <link rel="stylesheet" th:href="@{/css/all.min.css}" />
    <link rel="stylesheet" th:href="@{/css/animate.css}" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/flaticon.css}" />
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" th:href="@{/css/odometer.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.carousel.min.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.theme.default.min.css}" />
    <link rel="shortcut icon" th:href="@{/images/favicon.png}" type="image/x-icon">

    <title th:text="'Admin - Room Layout - ' + ${room.name}">Admin - Room Layout</title>

    <style>
        body { background-color: #032055; color: #ccc; }
        .admin-section { min-height: calc(100vh - 120px); padding-bottom: 50px;}
        .detail-card { background-color: rgba(10, 25, 50, 0.7); border: 1px solid #2d3450; border-radius: 8px; padding: 25px; margin-bottom: 30px; }
        .detail-card h4 { color: #31d7a9; margin-bottom: 20px; border-bottom: 1px solid #2d3450; padding-bottom: 10px; font-size: 1.25rem;}
        .detail-card p { margin-bottom: 12px; font-size: 1rem; line-height: 1.6; }
        .detail-card p strong { color: #a0a3bd; min-width: 120px; display: inline-block; font-weight: 600;}
        .table { color: #ccc; border-color: #2d3450; margin-top: 20px; font-size: 0.95rem;}
        .table th { color: #e0e0e0; background-color: #11255a; border-bottom-width: 1px; border-color: #3a4164 !important; padding: 12px 15px; text-transform: uppercase; font-weight: 600;}
        .table td { border-color: #2d3450 !important; vertical-align: middle; padding: 10px 15px;}
        .color-preview { display: inline-block; width: 20px; height: 20px; border-radius: 4px; border: 1px solid #777; vertical-align: middle; margin-right: 8px;}
        .btn-action-group a { margin-left: 10px; }
        .btn-back { display: inline-block; padding: 10px 20px; background: #5a6268; color: #fff; border-radius: 25px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; border: none; }
        .btn-back:hover { background: #495057; }
        .btn-back i { margin-right: 5px; }

        .header-section { background-color: rgba(3, 22, 60, 0.8); backdrop-filter: blur(5px); }
        .header-user-greeting { color: #a0a3bd; margin-right: 15px; }
        .logout-button-form { display: inline; }
        .logout-button-styled {
            background: transparent;
            border: 1px solid #31d7a9;
            color: #31d7a9;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .logout-button-styled:hover { background: #31d7a9; color: #032055; }
    </style>
</head>
<body>
    <div class="preloader"><div class="preloader-inner"><div class="preloader-icon"><span></span><span></span></div></div></div>
    <div class="overlay"></div>
    <a href="#" class="scrollToTop"><i class="fas fa-angle-up"></i></a>

     <header class="header-section">
        <div class="container">
            <div class="header-wrapper">
                <div class="logo">
                    <a th:href="@{/admin}">
                        <img th:src="@{/images/logo.png}" alt="logo">
                         <span style="color: white; margin-left: 10px; font-weight: bold;">Admin Panel</span>
                    </a>
                </div>
                <ul class="menu">
                    <li><a th:href="@{/admin}" th:classappend="${currentURI != null and (#strings.equals(currentURI, '/admin') or #strings.equals(currentURI, '/admin/'))} ? 'active' : ''">Dashboard</a></li>
                    <li class="menu-item-has-children"
                        th:classappend="${currentURI != null and (
                                            #strings.startsWith(currentURI, '/admin/users') or
                                            #strings.startsWith(currentURI, '/admin/movies') or
                                            #strings.startsWith(currentURI, '/admin/bookings') or
                                            #strings.startsWith(currentURI, '/admin/seat-types') or
                                            #strings.startsWith(currentURI, '/admin/rooms')
                                        )} ? 'active' : ''">
                        <a href="#">Management</a>
                        <ul class="submenu">
                            <li><a th:href="@{/admin/users}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/users')} ? 'active' : ''">Users</a></li>
                            <li><a th:href="@{/admin/movies}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/movies')} ? 'active' : ''">Movies</a></li>
                            <li><a th:href="@{/admin/seat-types}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/seat-types')} ? 'active' : ''">Seat Types</a></li>
                            <li><a th:href="@{/admin/rooms}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/rooms')} ? 'active' : ''">Rooms</a></li>
                        </ul>
                    </li>
                    <li><a th:href="@{/admin/settings}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/settings')} ? 'active' : ''">Settings</a></li>
                    <li><a th:href="@{/home}" target="_blank">View Site</a></li>
                    <li class="header-button pr-0" sec:authorize="isAuthenticated()">
                        <span class="header-user-greeting">Xin ch√†o, <b sec:authentication="name">Admin</b>!</span>
                        <form class="logout-button-form" th:action="@{/logout}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="logout-button-styled" type="submit">LOG OUT</button>
                        </form>
                    </li>
                </ul>
                <div class="header-bar d-lg-none"><span></span><span></span><span></span></div>
            </div>
        </div>
    </header>

    <section class="admin-section padding-top padding-bottom">
        <div class="container">

            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                <h2 style="color: white; border-bottom: 1px solid #2d3450; padding-bottom: 10px; margin-bottom:10px; flex-grow: 1;">
                    Room Layout: <span th:text="${room.name}">Room Name</span>
                </h2>
                <div class="btn-action-group">
                    <a th:href="@{/admin/rooms}" class="btn btn-sm btn-back"><i class="fas fa-arrow-left"></i> Back to List</a>
                    <a th:href="@{/admin/rooms/edit/{roomId}(roomId=${room.id})}" class="btn btn-sm btn-info"><i class="fas fa-edit"></i> Edit Structure</a>
                </div>
            </div>

            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${successMessage}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${errorMessage}"></div>

            <div class="detail-card">
                <h4>Room Information</h4>
                <p><strong>ID:</strong> <span th:text="${room.id}"></span></p>
                <p><strong>Name:</strong> <span th:text="${room.name}"></span></p>
                <p><strong>Capacity:</strong> <span th:text="${room.capacity}"></span> seats</p>
                <p><strong>Status:</strong>
                    <span th:if="${room.isActive}" class="badge bg-success">Active</span>
                    <span th:unless="${room.isActive}" class="badge bg-secondary">Inactive</span>
                </p>
            </div>

            <div class="seat-type-palette detail-card">
                <h4>Available Seat Types (Drag to assign)</h4>
                <div th:if="${availableSeatTypes != null and not #lists.isEmpty(availableSeatTypes)}">
                    <div class="draggable-seat-type"
                         th:each="type : ${availableSeatTypes}"
                         th:text="${type.name}"
                         th:style="${type.color != null ? 'background-color:' + type.color + ';' : 'background-color: #888;'}"
                         th:attr="data-seat-type-id=${type.id}, data-seat-type-name=${type.name}, data-seat-type-color=${type.color != null ? type.color : '#888888'}">
                    </div>
                    <div class="draggable-seat-type"
                         style="background-color: #4a5a80;"
                         data-seat-type-id="" data-seat-type-name="Unassigned" data-seat-type-color="#6c757d">
                         Unassign
                    </div>
                </div>
                <div th:unless="${availableSeatTypes != null and not #lists.isEmpty(availableSeatTypes)}">
                    <p class="text-warning">No active seat types found. Please add or activate seat types.</p>
                </div>
            </div>

            <div class="seat-map-section detail-card">
                <h4>Seat Layout</h4>
                <p class="text-muted"><small>Drag a seat type from above and drop it onto a seat below to assign its type.</small></p>
                <div th:if="${groupedSeatsByRow != null and not #lists.isEmpty(groupedSeatsByRow.entrySet())}">
                    <div class="seat-map-container">
                        <div class="screen">SCREEN</div>
                        <table class="seat-table">
                            <tbody>
                                <tr th:each="rowEntry : ${groupedSeatsByRow.entrySet()}">
                                    <td class="row-identifier-cell" th:text="${rowEntry.key}"></td>
                                    <td th:each="seat : ${rowEntry.value}" class="seat-cell">
                                        <div class="seat"
                                             th:id="'seat-' + ${seat.id}"
                                             th:attr="data-seat-id=${seat.id}, data-room-id=${room.id}"
                                             th:title="${'Row: ' + seat.rowIdentifier + ', Seat: ' + seat.seatNumber + (seat.seatType != null ? ' (' + seat.seatType.name + ')' : ' (Unassigned)') + (!seat.available ? ' - BOOKED' : '')}"
                                             th:style="${seat.available and seat.seatType != null and seat.seatType.color != null ? 'background-color:' + seat.seatType.color + ';' : ''}"
                                             th:classappend="(${!seat.available ? 'seat-booked' : 'dropzone'}) + ' ' + (${seat.seatType == null ? 'seat-type-unassigned' : 'seat-type-' + #strings.toLowerCase(seat.seatType.name).replace(' ','-')})">
                                            <span th:text="${seat.seatNumber}"></span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div th:unless="${groupedSeatsByRow != null and not #lists.isEmpty(groupedSeatsByRow.entrySet())}">
                     <p class="text-warning">No seats defined for this room yet. Please <a th:href="@{/admin/rooms/edit/{roomId}(roomId=${room.id})}">edit the room structure</a>.</p>
                </div>
            </div>
        </div>
    </section>

    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/modernizr-3.6.0.min.js}"></script>
    <script th:src="@{/js/plugins.js}"></script>
    <script th:src="@{/js/magnific-popup.min.js}"></script>
    <script th:src="@{/js/nice-select.js}"></script>
    <script th:src="@{/js/odometer.min.js}"></script>
    <script th:src="@{/js/owl.carousel.min.js}"></script>
    <script th:src="@{/js/viewport.js}"></script>
    <script th:src="@{/js/wow.min.js}"></script>
    <script th:src="@{/js/countdown.min.js}"></script>
    <script th:src="@{/js/isotope.pkgd.min.js}"></script>
    <script th:src="@{/js/main.js}"></script>

    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        console.log("Admin room layout manager page loaded for room ID:", /*[[${room != null ? room.id : 'N/A'}]]*/ 'N/A');
        if (typeof $.fn.preloader === 'function' && $('.preloader').length) {
            $('.preloader').fadeOut(500, function() { $(this).remove(); });
        } else if ($('.preloader').length) {
            $('.preloader').remove();
        }

        const csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
        const csrfHeaderName = /*[[${_csrf != null ? _csrf.headerName : ''}]]*/ '';

        if (typeof interact !== 'undefined') {
            console.log('InteractJS is loaded. Initializing draggable and dropzone.');
            interact('.draggable-seat-type').draggable({
                inertia: true,
                modifiers: [
                    interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })
                ],
                autoScroll: true,
                listeners: {
                    start(event) {
                        console.log('Draggable start:', event.target);
                        event.target.classList.add('dragging');
                    },
                    move(event) {
                        const target = event.target;
                        let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                        let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                        target.style.transform = `translate(${x}px, ${y}px)`;
                        target.setAttribute('data-x', x);
                        target.setAttribute('data-y', y);
                    },
                    end(event) {
                        console.log('Draggable end:', event.target);
                        const target = event.target;
                        target.style.transform = '';
                        target.setAttribute('data-x', 0);
                        target.setAttribute('data-y', 0);
                        target.classList.remove('dragging');
                    }
                }
            });

            interact('.seat.dropzone:not(.seat-booked)').dropzone({
                accept: '.draggable-seat-type',
                overlap: 0.25,
                ondragenter(event) {
                    // console.log('Dropzone ondragenter:', event.target);
                    if (!event.target.classList.contains('seat-booked')) {
                        event.target.classList.add('drop-target');
                    }
                },
                ondragleave(event) {
                    // console.log('Dropzone ondragleave:', event.target);
                    event.target.classList.remove('drop-target');
                },
                ondropactivate(event) {
                    // console.log('Dropzone ondropactivate:', event.target);
                    if (!event.target.classList.contains('seat-booked')) {
                        event.target.classList.add('drop-active');
                    }
                },
                ondropdeactivate(event) {
                    // console.log('Dropzone ondropdeactivate:', event.target);
                    event.target.classList.remove('drop-active');
                    event.target.classList.remove('drop-target');
                },
                ondrop(event) {
                    console.log('%c--- ONDROP EVENT FIRED ---', 'color: blue; font-weight: bold;');
                    const dropzoneSeatDiv = $(event.target);
                    const draggableTypeDiv = $(event.relatedTarget);

                    console.log('Dropzone (Seat DIV):', dropzoneSeatDiv[0]);
                    console.log('Draggable (Type DIV):', draggableTypeDiv[0]);


                    if (dropzoneSeatDiv.hasClass('seat-booked')) {
                        console.warn('Drop on booked seat prevented. Exiting ondrop.');
                        $('<div class="alert alert-warning alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
                            'Cannot change type of a booked seat.' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                            '</div>').appendTo('body').delay(3000).fadeOut(function() { $(this).remove(); });
                        return;
                    }

                    const seatId = dropzoneSeatDiv.data('seat-id');
                    const roomId = dropzoneSeatDiv.data('room-id');
                    const newSeatTypeId = draggableTypeDiv.data('seat-type-id');
                    const newSeatTypeName = draggableTypeDiv.data('seat-type-name');
                    const newSeatTypeColor = draggableTypeDiv.data('seat-type-color');

                    console.log('Data from Draggable:', { newSeatTypeId, newSeatTypeName, newSeatTypeColor });
                    console.log('Data from Dropzone:', { seatId, roomId, initialClasses: dropzoneSeatDiv.attr('class'), initialBgColor: dropzoneSeatDiv.css('background-color') });


                    // --- BEGIN OPTIMISTIC UPDATE ---
                    console.log('%cStarting Optimistic Update...', 'color:Teal; font-weight:bold;');

                    const oldState = {
                        backgroundColor: dropzoneSeatDiv.css('background-color'),
                        classes: dropzoneSeatDiv.attr('class'),
                        title: dropzoneSeatDiv.attr('title'),
                        currentTypeId: dropzoneSeatDiv.data('current-type-id')
                    };
                    console.log('Saved oldState:', oldState);

                    const classesBeforeRemove = dropzoneSeatDiv.attr('class');
                    dropzoneSeatDiv.removeClass(function(index, className) {
                        return (className.match(/(^|\s)seat-type-\S+/g) || []).join(' ');
                    });
                    console.log('Classes after removing old type:', dropzoneSeatDiv.attr('class'), '(was:', classesBeforeRemove, ')');

                    let tempTypeNameClass = 'unassigned';
                    let tempTitleTypeSuffix = ' (Unassigned)';

                    if (newSeatTypeId && String(newSeatTypeId).trim() !== "") {
                        tempTypeNameClass = String(newSeatTypeName).toLowerCase().replace(/\s+/g, '-');
                        tempTitleTypeSuffix = ` (${newSeatTypeName})`;
                        console.log('Applying specific type. Color to apply:', newSeatTypeColor, 'Type name class:', tempTypeNameClass);
                        if (newSeatTypeColor && newSeatTypeColor.trim() !== "") { // Ensure color is not empty
                            dropzoneSeatDiv.css('background-color', newSeatTypeColor);
                            console.log('Set background-color to:', newSeatTypeColor, '. Current actual bg:', dropzoneSeatDiv.css('background-color'));
                        } else {
                            dropzoneSeatDiv.css('background-color', ''); // Reset color
                            console.log('Draggable has no color or color is empty. Reset background-color. Current actual bg:', dropzoneSeatDiv.css('background-color'));
                        }
                    } else {
                        console.log('Applying unassign type. Resetting background-color.');
                        dropzoneSeatDiv.css('background-color', ''); // Reset color
                        console.log('Reset background-color for unassign. Current actual bg:', dropzoneSeatDiv.css('background-color'));
                    }
                    dropzoneSeatDiv.addClass('seat-type-' + tempTypeNameClass);
                    console.log('Added class: seat-type-' + tempTypeNameClass + '. Current classes:', dropzoneSeatDiv.attr('class'));

                    const seatNumberSpan = dropzoneSeatDiv.find('span').first();
                    const seatNumberText = seatNumberSpan.length ? seatNumberSpan.text() : String(dropzoneSeatDiv.data('seat-id')).split('-').pop();
                    const rowCell = dropzoneSeatDiv.closest('tr').find('.row-identifier-cell');
                    const rowIdentifier = rowCell.length ? rowCell.text() : 'Unknown Row';
                    const baseTitle = `Row: ${rowIdentifier}, Seat: ${seatNumberText}`;
                    const bookedStatusText = dropzoneSeatDiv.hasClass('seat-booked') ? ' - BOOKED' : '';
                    dropzoneSeatDiv.attr('title', baseTitle.trim() + tempTitleTypeSuffix + bookedStatusText);
                    dropzoneSeatDiv.data('current-type-id', newSeatTypeId);
                    console.log('Updated title to:', dropzoneSeatDiv.attr('title'));

                    console.log('%c--- OPTIMISTIC UI UPDATE COMPLETE ---', 'color: green; font-weight: bold;');

                    console.log('Calling updateSeatTypeOnServerOptimistic...');
                    updateSeatTypeOnServerOptimistic(dropzoneSeatDiv, seatId, roomId, newSeatTypeId, newSeatTypeColor, oldState);
                }
            });
        } else {
            console.error("InteractJS is not loaded!");
            $('<div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
                'Drag and drop functionality is not available. Please check the console.' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>').appendTo('body');
        }

        function updateSeatTypeOnServerOptimistic(seatDiv, seatId, roomId, newSeatTypeId, newSeatTypeColorParam, oldState) {
            console.log('%c--- updateSeatTypeOnServerOptimistic CALLED ---', 'color: orange; font-weight: bold;');
            console.log('Params:', {seatId, roomId, newSeatTypeId, newSeatTypeColorParam});
            // console.log('Old state for potential rollback:', oldState); // Already logged in ondrop

            let url = `/admin/rooms/${roomId}/seats/${seatId}/update-type`;
            let requestData = {};
            if (newSeatTypeId !== undefined && newSeatTypeId !== null && String(newSeatTypeId).trim() !== "") {
                requestData.seatTypeId = newSeatTypeId;
            }

            console.log(`AJAX POST to ${url} with data:`, requestData);
            seatDiv.css('opacity', '0.7');

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                data: requestData,
                beforeSend: function(xhr) {
                    console.log('AJAX beforeSend. CSRF Header:', csrfHeaderName, 'Token:', csrfToken ? 'Exists' : 'Missing');
                    if (csrfHeaderName && csrfToken) {
                        xhr.setRequestHeader(csrfHeaderName, csrfToken);
                    }
                },
                success: function(response) {
                    console.log('%cAJAX Success!', 'color: green; font-weight:bold;', 'Server Response:', response);
                    seatDiv.data('current-type-id', response.newSeatTypeId);

                    let successMsg = 'Seat type updated successfully!';
                    if (response && response.message) {
                        successMsg = response.message;
                    } else if (!response.newSeatTypeId && !(response && response.message)) {
                        successMsg = 'Seat unassigned successfully!';
                    }
                    console.log('Displaying success message:', successMsg);
                    $('<div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
                        successMsg +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                        '</div>').appendTo('body').delay(3000).fadeOut(function() { $(this).remove(); });
                },
                error: function(xhr, status, error) {
                    console.error('%cAJAX Error!', 'color: red; font-weight:bold;', 'Status:', status, 'Error:', error, 'Response Text:', xhr.responseText);
                    
                    console.warn('Rolling back UI due to AJAX error. Old state was:', oldState);
                    seatDiv.attr('class', oldState.classes);
                    seatDiv.css('background-color', oldState.backgroundColor);
                    seatDiv.attr('title', oldState.title);
                    seatDiv.data('current-type-id', oldState.currentTypeId);
                    console.log('UI Rolled back. Current classes:', seatDiv.attr('class'), 'Current bg:', seatDiv.css('background-color'));


                    let errorMsg = 'Error updating seat type. Changes have been reverted.';
                    try {
                        const errorDetail = JSON.parse(xhr.responseText); // Th·ª≠ parse responseText
                        if (errorDetail && errorDetail.message) {
                             errorMsg = errorDetail.message + " Changes reverted.";
                        } else if (xhr.responseJSON && xhr.responseJSON.error) { // jQuery c√≥ th·ªÉ ƒë√£ parse n·∫øu content-type l√† application/json
                            errorMsg = xhr.responseJSON.error + " Changes reverted.";
                        }
                    } catch (e) {
                        console.warn('Could not parse error responseText as JSON.', e);
                        if(xhr.responseText && xhr.responseText.length < 200) { // Hi·ªÉn th·ªã response text n·∫øu ng·∫Øn g·ªçn
                            errorMsg = 'Server error: ' + xhr.responseText.substring(0,100) + "... Changes reverted.";
                        }
                    }
                    console.log('Displaying error message:', errorMsg);
                    $('<div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
                        errorMsg +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                        '</div>').appendTo('body').delay(5000).fadeOut(function() { $(this).remove(); });
                },
                complete: function(xhr, textStatus) {
                    console.log('AJAX Complete. Status:', textStatus);
                    seatDiv.css('opacity', '1');
                }
            });
        }
    });
    /*]]>*/
    </script>
</body>
</html>