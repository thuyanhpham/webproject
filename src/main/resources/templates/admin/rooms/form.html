<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- CSS Links -->
    <link rel="stylesheet" th:href="@{/css/all.min.css}" />
    <link rel="stylesheet" th:href="@{/css/animate.css}" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/css.css}" />
    <link rel="stylesheet" th:href="@{/css/flaticon.css}" />
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" th:href="@{/css/odometer.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.carousel.min.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.theme.default.min.css}" />
    <link rel="shortcut icon" th:href="@{/images/favicon.png}" type="image/x-icon">

    <!-- Sử dụng th:object="${roomForm}" -->
    <title th:text="${roomForm.id == null} ? 'Admin - Add Room' : 'Admin - Edit Room (' + roomForm.name + ')'">Admin - Room Form</title>

    <style>
        body { background-color: #032055; color: #ccc; }
        .admin-section { min-height: calc(100vh - 160px); padding-bottom: 50px;}
        .form-label { color: #a0a3bd; margin-bottom: .5rem; font-weight: 500;}
        .form-control, .form-select {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #2d3450;
            color: #fff;
            border-radius: 5px;
        }
        .form-control:focus, .form-select:focus {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #50a6fc;
            color: #fff;
            box-shadow: none;
        }
        .form-control::placeholder { color: #6c757d; }
        .btn-save { display: inline-block; padding: 12px 30px; background: linear-gradient(to bottom, #31d7a9, #27aa80); color: #001232; border-radius: 25px; text-decoration: none; font-weight: 700; transition: all 0.3s ease; border: none; text-transform: uppercase; letter-spacing: 1px; }
        .btn-save:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(49, 215, 169, 0.3); }
        .btn-cancel { display: inline-block; padding: 10px 25px; background: transparent; color: #aaa; border-radius: 25px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; border: 1px solid #444; margin-left: 15px; }
        .btn-cancel:hover { background: #444; color: #fff; }
        .required-star { color: #ff4343; margin-left: 2px;}
        .text-danger, .global-error { color: #ff4343 !important; font-size: 0.875em; margin-top: .25rem; }
        .field-error { /* Thêm style cho lỗi của từng field trong row definition nếu cần */
            display: block; /* Để lỗi hiển thị dưới input */
            width: 100%;
        }
        .alert { margin-bottom: 20px; border-radius: 5px;}
        .header-section { background: #071240; }
        .header-section .menu > li > a.active,
        .header-section .menu .submenu li a.active { color: #31d7a9 !important; font-weight: 600; }
        .header-user-greeting { color: #ccc; margin-right: 15px; font-size: 0.9em; }
        .header-user-greeting b { color: #ffffff; font-weight: 600; }
        .logout-button-form { display: inline-block; margin: 0; padding: 0; vertical-align: middle; }
        .logout-button-styled { background: linear-gradient(to right, #e1457a, #8f5ff3); color: #ffffff; padding: 10px 25px; border-radius: 50px; text-transform: uppercase; font-weight: 700; font-size: 14px; letter-spacing: 1px; text-decoration: none; display: inline-block; transition: all 0.3s ease; border: none; cursor: pointer; line-height: normal; text-align: center; vertical-align: middle; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
        .logout-button-styled:hover { opacity: 0.9; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); transform: translateY(-1px); }

        .footer-section { background: #03173a; text-align: center; padding: 20px 0; margin-top: 40px; border-top: 1px solid #1a2c5c;}
        .row-definition { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: flex-start; padding-bottom: 10px; border-bottom: 1px dashed #2d3450;}
        .row-definition:last-child { border-bottom: none; }
        .row-definition > div { display: flex; flex-direction: column; } /* Để label và input/error chồng lên nhau */
        .row-definition input[type="text"], .row-definition input[type="number"] { flex-grow: 1; }
        .row-definition .row-identifier-input-container { min-width: 100px; flex-basis: 150px; }
        .row-definition .seats-per-row-input-container { min-width: 100px; flex-basis: 150px;}
        .row-definition .row-order-input-container { min-width: 100px; flex-basis: 120px;}
        .row-definition .remove-btn-container { display: flex; align-items: center; padding-top: 28px; /* Căn chỉnh với input khi có label */}

        .btn-remove-row { color: #dc3545; cursor: pointer; font-size: 1.2em; padding: 5px; line-height: 1;}
        .btn-remove-row:hover { color: #ff4343; }
    </style>
</head>
<body>
    <div class="preloader"><div class="preloader-inner"><div class="preloader-icon"><span></span><span></span></div></div></div>
    <div class="overlay"></div>
    <a href="#" class="scrollToTop"><i class="fas fa-angle-up"></i></a>

    <!-- ==================== Header Section ==================== -->
    <header class="header-section">
        <div class="container">
            <div class="header-wrapper">
                <div class="logo">
                    <a th:href="@{/admin}">
                        <img th:src="@{/images/logo.png}" alt="logo">
                         <span style="color: white; margin-left: 10px; font-weight: bold;">Admin Panel</span>
                    </a>
                </div>
                <ul class="menu">
                    <li><a th:href="@{/admin}" th:classappend="${currentURI != null and (#strings.equals(currentURI, '/admin') or #strings.equals(currentURI, '/admin/'))} ? 'active' : ''">Dashboard</a></li>
                    <li class="menu-item-has-children"
                        th:classappend="${currentURI != null and (
                                            #strings.startsWith(currentURI, '/admin/users') or
                                            #strings.startsWith(currentURI, '/admin/movies') or
                                            #strings.startsWith(currentURI, '/admin/bookings') or
                                            #strings.startsWith(currentURI, '/admin/seat-types') or
                                            #strings.startsWith(currentURI, '/admin/rooms')
                                        )} ? 'active' : ''">
                        <a href="#">Management</a>
                        <ul class="submenu">
                            <li><a th:href="@{/admin/users}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/users')} ? 'active' : ''">Users</a></li>
                            <li><a th:href="@{/admin/movies}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/movies')} ? 'active' : ''">Movies</a></li>
                            <li><a th:href="@{/admin/seat-types}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/seat-types')} ? 'active' : ''">Seat Types</a></li>
                            <li><a th:href="@{/admin/rooms}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/rooms')} ? 'active' : ''">Rooms</a></li>
                        </ul>
                    </li>
                    <li><a th:href="@{/admin/settings}" th:classappend="${currentURI != null and #strings.startsWith(currentURI, '/admin/settings')} ? 'active' : ''">Settings</a></li>
                    <li><a th:href="@{/home}" target="_blank">View Site</a></li>
                    <li class="header-button pr-0" sec:authorize="isAuthenticated()">
                        <span class="header-user-greeting">Xin chào, <b sec:authentication="name">Admin</b>!</span>
                        <form class="logout-button-form" th:action="@{/logout}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="logout-button-styled" type="submit">LOG OUT</button>
                        </form>
                    </li>
                </ul>
                <div class="header-bar d-lg-none"><span></span><span></span><span></span></div>
            </div>
        </div>
    </header>
    <!-- ==================== End Header Section ==================== -->

    <section class="admin-section padding-top padding-bottom">
        <div class="container">
            <h2 class="mb-4" style="color: white; border-bottom: 1px solid #2d3450; padding-bottom: 15px;">
                <span th:text="*{id == null ? 'Add New Room' : 'Edit Room'}"></span>
                <span th:if="*{id != null}" th:text="' (' + *{name} + ')'"></span>
            </h2>

            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <form th:action="@{/admin/rooms/save}" th:object="${roomForm}" method="post" class="mt-4">

                <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger global-error" role="alert">
                    <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <input type="hidden" th:field="*{id}" />

                <div class="mb-3">
                    <label for="name" class="form-label">Room Name <span class="required-star">*</span></label>
                    <input type="text" class="form-control" id="name" th:field="*{name}">
                    <div class="text-danger field-error" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                </div>

                <div class="mb-3">
                    <label for="capacity" class="form-label">Total Capacity</label>
                    <!-- Hiển thị capacity được tính bởi DTO hoặc JS, không submit -->
                    <input type="number" min="0" class="form-control" id="capacity" name="displayCapacity" readonly th:value="*{capacity}">
                    <small class="form-text" style="color: #888;">Calculated automatically from defined rows and seats.</small>
                </div>

                <div class="mb-3">
                    <h5 style="color: #31d7a9;">Define Seat Rows</h5>
                    <div id="seat-rows-container">
                        <th:block th:if="*{rowDefinitions != null and not #lists.isEmpty(rowDefinitions)}">
                             <div th:each="rowDef, iterStat : *{rowDefinitions}" class="row-definition">
                                 <div class="row-identifier-input-container">
                                     <label th:for="${'rowDefinitions' + iterStat.index + '.identifier'}" class="form-label">Row ID <span class="required-star">*</span></label>
                                     <input type="text" class="form-control form-control-sm row-identifier-input"
                                            th:field="*{rowDefinitions[__${iterStat.index}__].identifier}"
                                            placeholder="e.g., A"/>
                                     <div class="text-danger field-error" th:if="${#fields.hasErrors('rowDefinitions[__${iterStat.index}__].identifier')}" th:errors="*{rowDefinitions[__${iterStat.index}__].identifier}"></div>
                                 </div>

                                 <div class="seats-per-row-input-container">
                                     <label th:for="${'rowDefinitions' + iterStat.index + '.numberOfSeats'}" class="form-label"># Seats <span class="required-star">*</span></label>
                                     <input type="number" class="form-control form-control-sm seats-per-row-input"
                                            th:field="*{rowDefinitions[__${iterStat.index}__].numberOfSeats}"
                                            placeholder="# Seats" min="1"/>
                                     <div class="text-danger field-error" th:if="${#fields.hasErrors('rowDefinitions[__${iterStat.index}__].numberOfSeats')}" th:errors="*{rowDefinitions[__${iterStat.index}__].numberOfSeats}"></div>
                                 </div>

                                 <div class="row-order-input-container">
                                     <label th:for="${'rowDefinitions' + iterStat.index + '.order'}" class="form-label">Order <span class="required-star">*</span></label>
                                     <input type="number" class="form-control form-control-sm row-order-input"
                                            th:field="*{rowDefinitions[__${iterStat.index}__].order}"
                                            placeholder="Order" min="0"/>
                                     <div class="text-danger field-error" th:if="${#fields.hasErrors('rowDefinitions[__${iterStat.index}__].order')}" th:errors="*{rowDefinitions[__${iterStat.index}__].order}"></div>
                                 </div>

                                 <div class="remove-btn-container">
                                     <i class="fas fa-times btn-remove-row" title="Remove this row"></i>
                                 </div>
                             </div>
                        </th:block>
                    </div>
                    <button type="button" id="add-seat-row-definition-btn" class="btn btn-outline-light btn-sm mt-2">
                        <i class="fas fa-plus"></i> Add Row Definition
                    </button>
                    <!-- Hiển thị lỗi chung cho list rowDefinitions, ví dụ @NotEmpty -->
                    <div class="text-danger field-error mt-2" th:if="${#fields.hasErrors('rowDefinitions')}" th:errors="*{rowDefinitions}"></div>
                </div>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="mt-4 text-center">
                    <button type="submit" class="btn-save">Save Room & Layout</button>
                    <a th:href="@{/admin/rooms}" class="btn-cancel">Cancel</a>
                </div>
            </form>
        </div>
    </section>

    <script th:src="@{/js/jquery-3.3.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/main.js}"></script>

    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        const seatRowsContainer = $('#seat-rows-container');
        // Khởi tạo nextRowIndex dựa trên số lượng rowDefinitions đã được render bởi Thymeleaf
        let nextRowIndex = /*[[*{rowDefinitions != null ? #lists.size(rowDefinitions) : 0}]]*/ 0;

        function updateTotalCapacity() {
            let totalCapacity = 0;
            $('.seats-per-row-input').each(function() {
                const seats = parseInt($(this).val());
                if (!isNaN(seats) && seats > 0) {
                    totalCapacity += seats;
                }
            });
            $('#capacity').val(totalCapacity); // Cập nhật input hiển thị capacity
        }

        function createRowDefinitionHTML(index, identifier = '', numberOfSeats = 10, order = 0) {
            // Các `name` phải khớp với cấu trúc mà Spring MVC mong đợi: "rowDefinitions[index].propertyName"
            return `
                <div class="row-definition">
                    <div class="row-identifier-input-container">
                         <label for="rowDefinitions${index}.identifier" class="form-label">Row ID <span class="required-star">*</span></label>
                         <input type="text" class="form-control form-control-sm row-identifier-input"
                                name="rowDefinitions[${index}].identifier" id="rowDefinitions${index}.identifier"
                                placeholder="e.g., A" value="${identifier}"/>
                         <div class="text-danger field-error" id="error-rowDefinitions.${index}.identifier"></div>
                    </div>
                    <div class="seats-per-row-input-container">
                         <label for="rowDefinitions${index}.numberOfSeats" class="form-label"># Seats <span class="required-star">*</span></label>
                         <input type="number" class="form-control form-control-sm seats-per-row-input"
                                name="rowDefinitions[${index}].numberOfSeats" id="rowDefinitions${index}.numberOfSeats"
                                placeholder="# Seats" value="${numberOfSeats}" min="1"/>
                         <div class="text-danger field-error" id="error-rowDefinitions.${index}.numberOfSeats"></div>
                    </div>
                    <div class="row-order-input-container">
                         <label for="rowDefinitions${index}.order" class="form-label">Order <span class="required-star">*</span></label>
                         <input type="number" class="form-control form-control-sm row-order-input"
                                name="rowDefinitions[${index}].order" id="rowDefinitions${index}.order"
                                placeholder="Order" value="${order}" min="0"/>
                         <div class="text-danger field-error" id="error-rowDefinitions.${index}.order"></div>
                    </div>
                    <div class="remove-btn-container">
                        <i class="fas fa-times btn-remove-row" title="Remove this row"></i>
                    </div>
                </div>`;
        }

        $('#add-seat-row-definition-btn').on('click', function() {
            let currentMaxOrder = -1; // Bắt đầu từ -1 để hàng đầu tiên có order là 0 nếu chưa có hàng nào
            seatRowsContainer.find('.row-order-input').each(function() {
                const orderVal = parseInt($(this).val());
                if (!isNaN(orderVal) && orderVal > currentMaxOrder) {
                    currentMaxOrder = orderVal;
                }
            });
            // Nếu chưa có hàng nào, order là 0 (hoặc 1 tùy bạn muốn). Nếu có, order tiếp theo là max + 1.
            const newOrder = (currentMaxOrder === -1 && seatRowsContainer.find('.row-definition').length === 0) ? 0 : currentMaxOrder + 1;

            const newRowHTML = createRowDefinitionHTML(nextRowIndex, '', 10, newOrder);
            seatRowsContainer.append(newRowHTML);
            nextRowIndex++;
            updateTotalCapacity();
        });

        seatRowsContainer.on('click', '.btn-remove-row', function() {
            $(this).closest('.row-definition').remove();
            // Rất quan trọng: Cập nhật lại index cho các hàng còn lại
            nextRowIndex = 0;
            seatRowsContainer.find('.row-definition').each(function() {
                const currentIndex = nextRowIndex; // Lưu lại index hiện tại cho closure
                $(this).find('input[name^="rowDefinitions"], select[name^="rowDefinitions"]').each(function() {
                    let currentName = $(this).attr('name');
                    if (currentName) {
                        // Cập nhật name: rowDefinitions[oldIndex] -> rowDefinitions[newIndex]
                        let newName = currentName.replace(/rowDefinitions\[\d+\]/g, `rowDefinitions[${currentIndex}]`);
                        $(this).attr('name', newName);
                        // Cập nhật id (nếu có) và for của label (nếu có)
                        let currentId = $(this).attr('id');
                        if (currentId) {
                            let newId = currentId.replace(/rowDefinitions\d+/g, `rowDefinitions${currentIndex}`);
                            $(this).attr('id', newId);
                            // Tìm label tương ứng và cập nhật 'for'
                            $(this).closest('[class*="-input-container"]').find('label').attr('for', newId);
                        }
                        // Cập nhật id của div lỗi
                        let errorDiv = $(this).siblings('.text-danger.field-error');
                        if(errorDiv.length > 0 && errorDiv.attr('id')) {
                             let newErrorId = errorDiv.attr('id').replace(/rowDefinitions\.\d+\./g, `rowDefinitions.${currentIndex}.`);
                             errorDiv.attr('id', newErrorId);
                        }
                    }
                });
                nextRowIndex++;
            });
            updateTotalCapacity();
        });

        // Cập nhật capacity khi số ghế thay đổi
        seatRowsContainer.on('input', '.seats-per-row-input', function() {
            updateTotalCapacity();
        });

        // Xóa phần logic isNewRoom và hasInitialRowDefinitions cũ nếu không dùng rowDefinitionsForForm nữa.
        // Logic thêm hàng mặc định khi tạo mới đã được xử lý trong controller.
        // Tuy nhiên, nếu muốn thêm bằng JS khi trang load lần đầu (form mới, rỗng):
        // const isFormForNewRoom = /*[[*{id == null}]]*/ false; // Lấy từ th:object
        // if (isFormForNewRoom && nextRowIndex === 0) { // nextRowIndex được tính từ *{rowDefinitions}
        //    const initialRowHTML = createRowDefinitionHTML(nextRowIndex, 'A', 10, 0);
        //    seatRowsContainer.append(initialRowHTML);
        //    nextRowIndex++;
        // }

        updateTotalCapacity(); // Tính toán capacity ban đầu khi trang tải

        console.log("Admin room form page loaded. Next row index: " + nextRowIndex);
        $('.preloader').fadeOut(500, function() { $(this).remove(); });
        var alertList = document.querySelectorAll('.alert:not(.global-error)');
        alertList.forEach(function (alertEl) { new bootstrap.Alert(alertEl); });
    });
    /*]]>*/
    </script>
</body>
</html>