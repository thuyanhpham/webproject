<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script th:src="@{/js/jquery-3.3.1.min.js}"></script>

    <link rel="stylesheet" th:href="@{/css/all.min.css}" />
    <link rel="stylesheet" th:href="@{/css/animate.css}" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/css.css}" />
    <link rel="stylesheet" th:href="@{/css/flaticon.css}" />
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" th:href="@{/css/odometer.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.carousel.min.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.theme.default.min.css}" />
    <link rel="shortcut icon" th:href="@{/images/favicon.png}" type="image/x-icon">

    <title th:text="${roomForm.id == null || roomForm.id == 0} ? 'Admin - Add Room' : 'Admin - Edit Room (' + ${roomForm.name != null ? roomForm.name : ''} + ')'">Admin - Room Form</title>

    <style>
        /* General Theme Styles (Keep yours) */
        .header-section { background: #071240; }
        .header-section .menu > li > a.active { color: #31d7a9 !important; }
        .logout-button-form { display: inline-block; margin: 0; padding: 0; vertical-align: middle; }
        .logout-button-styled { background: linear-gradient(to right, #e1457a, #8f5ff3); color: #ffffff; padding: 10px 25px; border-radius: 50px; text-transform: uppercase; font-weight: 700; font-size: 14px; letter-spacing: 1px; text-decoration: none; display: inline-block; transition: all 0.3s ease; border: none; cursor: pointer; line-height: normal; text-align: center; vertical-align: middle; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
        .logout-button-styled:hover { opacity: 0.9; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); transform: translateY(-1px); }

        /* Row Definition Styles */
        .row-definition { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: flex-start; padding-bottom: 10px; border-bottom: 1px dashed #2d3450;}
        .row-definition:last-child { border-bottom: none; }
        .row-definition > div { display: flex; flex-direction: column; }
        .row-definition input[type="text"], .row-definition input[type="number"] { flex-grow: 1; }
        .row-definition .row-identifier-input-container { min-width: 100px; flex-basis: 150px; }
        .row-definition .seats-per-row-input-container { min-width: 100px; flex-basis: 150px;}
        .row-definition .row-order-input-container { min-width: 100px; flex-basis: 120px;}
        .row-definition .remove-btn-container { display: flex; align-items: center; padding-top: 26px; /* Adjust if needed */ }
        .btn-remove-row { color: #dc3545; cursor: pointer; font-size: 1.2em; padding: 5px; line-height: 1;}
        .btn-remove-row:hover { color: #ff4343; }
        .required-star { color: #ff4d4f; margin-left: 2px; font-weight: bold; }
        .field-error { font-size: 0.8em; display: block; min-height: 1em; }


        /* Seat Assignment Styles */
        .seat-type-palette-form div.draggable-seat-type { padding: 8px 12px; margin: 5px; border-radius: 5px; color: white; cursor: grab; display: inline-block; text-align: center; min-width: 90px; border: 1px solid rgba(255,255,255,0.2); font-size: 0.9em; }
        .seat-type-palette-form div.draggable-seat-type.dragging { opacity: 0.7; box-shadow: 0 4px 8px rgba(0,0,0,0.5); transform: scale(1.1); }
        .seat-layout-preview-container { background-color: rgba(0,0,0,0.1); padding: 15px; border-radius: 5px; border: 1px dashed #2d3450; margin-top: 10px; min-height: 100px; }
        .seat-layout-preview-container .screen-preview { background-color: #222; color: white; padding: 8px; margin-bottom: 15px; border-radius: 3px; font-weight: bold; text-align: center; letter-spacing: 1px; font-size: 0.9em; }
        .seat-layout-preview-container .seat-row-preview { display: flex; align-items: center; margin-bottom: 5px; }
        .seat-layout-preview-container .row-identifier-preview { font-weight: bold; color: #a0a3bd; min-width: 30px; text-align: right; margin-right: 10px; }
        .seat-layout-preview-container .seat-cell-preview { width: 30px; height: 30px; border: 1px solid #555; margin: 2px; display: flex; align-items: center; justify-content: center; font-size: 0.75em; border-radius: 3px; background-color: #6c757d; color: white; transition: background-color 0.2s ease, transform 0.1s ease; }
        .seat-layout-preview-container .seat-cell-preview.drop-active { border-color: #31d7a9; border-style: dashed; }
        .seat-layout-preview-container .seat-cell-preview.drop-target { background-color: rgba(49, 215, 169, 0.4) !important; transform: scale(1.05); }
        .no-layout-message { color: #888; text-align: center; padding: 20px;}

        /* Checkbox Is Active */
        .form-check-input.custom-small-checkbox { width: 0.85em; height: 0.85em; margin-top: 0.25em; transform: scale(0.9); transform-origin: left center; margin-right: 0.3em;}
        .form-check-label.custom-small-checkbox-label { font-size: 0.9em; padding-left: 0.1em; vertical-align: text-bottom;}

        /* Compact Buttons (Chiều ngang vừa text, chiều cao giữ nguyên) */
        #add-seat-row-definition-btn,
        #generateLayoutBtn {
            padding-left: 10px !important;
            padding-right: 10px !important;
            width: auto !important;
            min-width: 0 !important;
            display: inline-block !important;
        }
        #add-seat-row-definition-btn .fas,
        #generateLayoutBtn .fas {
            margin-right: 5px !important;
        }
        #generateLayoutBtn { /* Đảm bảo nút này không chiếm full width nếu nó có style block */
            display: inline-block !important;
        }

        /* Final Save and Cancel Buttons */
        #finalSaveBtn,
        a.btn-cancel {
            display: inline-block !important;
            width: auto !important;
            min-width: 0 !important;
            padding: 8px 16px !important; /* Điều chỉnh padding này để cân đối */
            font-size: 0.9rem !important;
            line-height: 1.5 !important;
            text-align: center;
            vertical-align: middle;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin: 0 5px;
        }
        #finalSaveBtn {
            background-color: #31d7a9 !important;
            color: #0d1422 !important;
            border-color: #31d7a9 !important;
            font-weight: bold;
        }
        #finalSaveBtn:hover, #finalSaveBtn:focus {
            background-color: #28b990 !important;
            border-color: #28b990 !important;
            color: #ffffff !important;
        }
        #finalSaveBtn .fas { margin-right: 6px; }

        a.btn-cancel {
            background-color: #6c757d !important; /* Bootstrap secondary color */
            color: #ffffff !important;
            border-color: #6c757d !important;
        }
        a.btn-cancel:hover, a.btn-cancel:focus {
            background-color: #5a6268 !important;
            border-color: #545b62 !important;
            color: #ffffff !important;
        }

    </style>
</head>
<body>
    <div class="preloader"><div class="preloader-inner"><div class="preloader-icon"><span></span><span></span></div></div></div>
    <div class="overlay"></div>
    <a href="#" class="scrollToTop"><i class="fas fa-angle-up"></i></a>

    <header class="header-section" th:replace="~{fragments/admin-header :: header}"></header>

    <section class="admin-section padding-top padding-bottom">
        <div class="container">
            <h2 class="mb-4" style="color: white; border-bottom: 1px solid #2d3450; padding-bottom: 15px;">
                <span th:text="${roomForm.id == null || roomForm.id == 0} ? 'Add New Room' : 'Edit Room'"></span>
                <span th:if="${roomForm.id != null && roomForm.id != 0}" th:text="' (' + ${roomForm.name} + ')'"></span>
            </h2>

            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <form id="roomForm" th:action="@{/admin/rooms/save}" th:object="${roomForm}" method="post" class="mt-4">
                <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger global-error" role="alert">
                    <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <input type="hidden" th:field="*{id}" />
                <input type="hidden" th:field="*{seatAssignmentsJson}" id="seatAssignmentsField" />
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>

                <div id="step1_defineRoom">
                    <div class="mb-3">
                        <label for="name" class="form-label">Room Name <span class="required-star">*</span></label>
                        <input type="text" class="form-control form-input-custom" id="name" th:field="*{name}">
                        <div class="text-danger field-error" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                    </div>

                    <div class="mb-3">
                        <label for="capacityDisplay" class="form-label">Total Capacity (Preview)</label>
                        <input type="number" class="form-control form-input-custom" id="capacityDisplay" name="displayCapacity" readonly value="0">
                        <small class="form-text" style="color: #888;">Calculated automatically from defined rows.</small>
                    </div>

                     <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input custom-small-checkbox" id="active" th:field="*{active}">
                        <label class="form-check-label custom-small-checkbox-label" for="active">Is Active</label>
                    </div>

                    <div class="mb-3">
                        <h5 style="color: #31d7a9;">Define Seat Rows</h5>
                        <div id="seat-rows-container">
                            <th:block th:if="*{rowDefinitions != null and not #lists.isEmpty(rowDefinitions)}">
                                <div th:each="rowDef, iterStat : *{rowDefinitions}" class="row-definition" th:attr="data-row-index=${iterStat.index}">
                                    <input type="hidden" th:field="*{rowDefinitions[__${iterStat.index}__].id}" />
                                    <div class="row-identifier-input-container">
                                        <label th:for="'rowDefinitions' + ${iterStat.index} + '.identifier'" class="form-label">Row ID <span class="required-star">*</span></label>
                                        <input type="text" class="form-control form-control-sm row-identifier-input form-input-custom"
                                                th:field="*{rowDefinitions[__${iterStat.index}__].identifier}"
                                                placeholder="e.g., A" style="text-transform: uppercase;"/>
                                        <div class="text-danger field-error small" th:if="${#fields.hasErrors('rowDefinitions[__${iterStat.index}__].identifier')}" th:errors="*{rowDefinitions[__${iterStat.index}__].identifier}"></div>
                                    </div>
                                    <div class="seats-per-row-input-container">
                                        <label th:for="'rowDefinitions' + ${iterStat.index} + '.numberOfSeats'" class="form-label"># Seats <span class="required-star">*</span></label>
                                        <input type="number" class="form-control form-control-sm seats-per-row-input form-input-custom"
                                                th:field="*{rowDefinitions[__${iterStat.index}__].numberOfSeats}"
                                                placeholder="# Seats" min="1"/>
                                        <div class="text-danger field-error small" th:if="${#fields.hasErrors('rowDefinitions[__${iterStat.index}__].numberOfSeats')}" th:errors="*{rowDefinitions[__${iterStat.index}__].numberOfSeats}"></div>
                                    </div>
                                    <div class="row-order-input-container">
                                        <label th:for="'rowDefinitions' + ${iterStat.index} + '.order'" class="form-label">Order <span class="required-star">*</span></label>
                                        <input type="number" class="form-control form-control-sm row-order-input form-input-custom"
                                                th:field="*{rowDefinitions[__${iterStat.index}__].order}"
                                                placeholder="Order" min="0"/>
                                        <div class="text-danger field-error small" th:if="${#fields.hasErrors('rowDefinitions[__${iterStat.index}__].order')}" th:errors="*{rowDefinitions[__${iterStat.index}__].order}"></div>
                                    </div>
                                    <input type="hidden" th:field="*{rowDefinitions[__${iterStat.index}__].seatTypeId}" />
                                    <div class="remove-btn-container">
                                        <i class="fas fa-times btn-remove-row" title="Remove this row"></i>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                        <button type="button" id="add-seat-row-definition-btn" class="btn btn-outline-light btn-sm mt-2 btn-compact">
                            <i class="fas fa-plus"></i> Add Row Definition
                        </button>
                        <div class="text-danger field-error mt-2" th:if="${#fields.hasErrors('rowDefinitions')}" th:errors="*{rowDefinitions}"></div>
                    </div>

                    <div class="my-4 text-center">
                        <button type="button" id="generateLayoutBtn" class="btn btn-info btn-compact">
                            <i class="fas fa-cogs"></i> Generate Layout & Proceed to Assign Types
                        </button>
                    </div>
                </div>

                <div id="seatAssignmentSection" style="display: none;">
                    <hr class="my-4" style="border-top: 1px solid #2d3450;">
                    <h4 style="color: #31d7a9;">Assign Seat Types</h4>
                    <p class="text-muted"><small>Drag a seat type from the palette and drop it onto a seat in the layout below.</small></p>
                    <div class="seat-type-palette-form mb-3">
                        <div class="draggable-seat-type"
                             th:each="type : ${availableSeatTypes}"
                             th:text="${type.name}"
                             th:style="${ (type.color != null ? 'background-color:' + type.color + ';' : 'background-color: #888;') + ' ' + (type.color != null and @roomService.isColorDark(type.color) ? 'color:white;' : 'color:black;') }"
                             th:attr="data-seat-type-id=${type.id}, data-seat-type-name=${type.name}, data-seat-type-color=${type.color != null ? type.color : '#888888'}">
                        </div>
                        <div class="draggable-seat-type" style="background-color: #6c757d; color:white;" data-seat-type-id="" data-seat-type-name="Unassign" data-seat-type-color="#6c757d">Unassign</div>
                    </div>
                    <div class="seat-layout-preview-container" id="seatLayoutPreview">
                        <div class="screen-preview" style="display:none;">SCREEN</div>
                        <div id="seat-rows-preview-target">
                            <p class="no-layout-message">Layout will be generated here.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-5 text-center">
                    <button type="submit" id="finalSaveBtn" class="btn-save" style="display: none;">
                        <i class="fas fa-save"></i> Save Room & Final Layout
                    </button>
                    <a th:href="@{/admin/rooms}" class="btn-cancel">Cancel</a>
                </div>
            </form>
        </div>
    </section>

    <script th:src="@{/js/jquery-3.3.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/modernizr-3.6.0.min.js}"></script>
    <script th:src="@{/js/plugins.js}"></script>
    <script th:src="@{/js/magnific-popup.min.js}"></script>
    <script th:src="@{/js/nice-select.js}"></script>
    <script th:src="@{/js/odometer.min.js}"></script>
    <script th:src="@{/js/owl.carousel.min.js}"></script>
    <script th:src="@{/js/viewport.js}"></script>
    <script th:src="@{/js/wow.min.js}"></script>
    <script th:src="@{/js/countdown.min.js}"></script>
    <script th:src="@{/js/isotope.pkgd.min.js}"></script>
    <script th:src="@{/js/contentInt.js}"></script>
    <script th:src="@{/js/chunk-7ac80a40.js}"></script>
    <script th:src="@{/js/main.js}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function () {
            console.log("Admin room form page loaded.");
            const seatRowsContainer = $('#seat-rows-container');

            const initialRowDefinitionsFromServer = /*[[${roomForm != null && roomForm.rowDefinitions != null ? roomForm.rowDefinitions : null}]]*/ null;
            const initialSeatAssignmentsJson = /*[[${roomForm.seatAssignmentsJson}]]*/ null; // JSON lồng nhau từ server

            let nextRowIndex = initialRowDefinitionsFromServer ? initialRowDefinitionsFromServer.length : 0;

            const seatLayoutPreviewTarget = $('#seat-rows-preview-target');
            const noLayoutMessage = $('#seatLayoutPreview .no-layout-message');
            const seatAssignmentSection = $('#seatAssignmentSection');
            const finalSaveBtn = $('#finalSaveBtn');
            const generateLayoutBtn = $('#generateLayoutBtn');
            const addRowBtn = $('#add-seat-row-definition-btn'); // Lấy reference nút add row

            let seatAssignments = {}; // Đối tượng để lưu trữ các gán ghế hiện tại
            let currentGeneratedRowDefinitions = []; // Danh sách các định nghĩa hàng sau khi "Generate Layout"

            const availableSeatTypes = /*[[${availableSeatTypes}]]*/ [];
            console.log("Available Seat Types on Load:", JSON.stringify(availableSeatTypes));
            console.log("Initial Row Definitions from Server:", JSON.stringify(initialRowDefinitionsFromServer));
            console.log("Initial Seat Assignments JSON (nested from service):", initialSeatAssignmentsJson);

            // Hàm kiểm tra màu tối/sáng, đặt ở đầu để các hàm khác có thể gọi
            function isColorDark(hexColor) {
                if (!hexColor || typeof hexColor !== 'string') return true; // Default là tối nếu không có màu hoặc sai kiểu
                let color = hexColor.startsWith('#') ? hexColor.substring(1) : hexColor;

                // Handle shorthand hex (e.g., #000)
                if (color.length === 3) {
                    color = color[0] + color[0] + color[1] + color[1] + color[2] + color[2];
                }

                if (color.length !== 6) {
                    console.warn("Invalid hex color format encountered:", hexColor);
                    // Có thể thử phân tích cú pháp RGB nếu cần, hoặc mặc định là tối
                    return true;
                }

                const r = parseInt(color.substring(0, 2), 16);
                const g = parseInt(color.substring(2, 4), 16);
                const b = parseInt(color.substring(4, 6), 16);

                // Sử dụng công thức Luma (Rec. 709) để tính độ sáng
                const luma = (0.2126 * r + 0.7152 * g + 0.0722 * b);
                return luma < 128; // Ngưỡng độ sáng (0-255)
            }

            // Cập nhật màu chữ cho draggable seat types dựa trên isColorDark khi tải trang
            $('.draggable-seat-type').each(function() {
                const bgColor = $(this).data('seat-type-color') || $(this).css('background-color');
                if (isColorDark(bgColor)) {
                    $(this).css('color', 'white');
                } else {
                    $(this).css('color', 'black');
                }
            });

            function calculateTempCapacityFromInputs() {
                let tempCap = 0;
                seatRowsContainer.find('.seats-per-row-input').each(function () {
                    const seats = parseInt($(this).val());
                    if (!isNaN(seats) && seats > 0) tempCap += seats;
                });
                $('#capacityDisplay').val(tempCap);
                console.log("Calculated temp capacity from INPUTS:", tempCap);
            }

            function calculateCapacityFromGeneratedLayout() {
                let tempCap = 0;
                if (Array.isArray(currentGeneratedRowDefinitions)) {
                    currentGeneratedRowDefinitions.forEach(def => { if (def && !isNaN(def.numberOfSeats)) tempCap += parseInt(def.numberOfSeats); });
                }
                $('#capacityDisplay').val(tempCap);
                console.log("Recalculated capacity from generated layout:", tempCap);
            }

            // Hàm tạo HTML cho một hàng định nghĩa
            function createRowDefinitionHTML(index, identifier = '', seats = 10, order = 0, existingRowDefId = '') {
                return `
                <div class="row-definition" data-row-index="${index}">
                    <input type="hidden" name="rowDefinitions[${index}].id" value="${existingRowDefId}">
                    <div class="row-identifier-input-container">
                        <label for="rowDefinitions${index}.identifier" class="form-label">Row ID <span class="required-star">*</span></label>
                        <input type="text" id="rowDefinitions${index}.identifier" name="rowDefinitions[${index}].identifier"
                               class="form-control form-control-sm row-identifier-input form-input-custom"
                               value="${identifier}" placeholder="e.g., A" required style="text-transform: uppercase;"/>
                        <div class="text-danger small field-error"></div>
                    </div>
                    <div class="seats-per-row-input-container">
                        <label for="rowDefinitions${index}.numberOfSeats" class="form-label"># Seats <span class="required-star">*</span></label>
                        <input type="number" id="rowDefinitions${index}.numberOfSeats" name="rowDefinitions[${index}].numberOfSeats"
                               class="form-control form-control-sm seats-per-row-input form-input-custom"
                               value="${seats}" placeholder="# Seats" min="1" required/>
                        <div class="text-danger small field-error"></div>
                    </div>
                    <div class="row-order-input-container">
                        <label for="rowDefinitions${index}.order" class="form-label">Order <span class="required-star">*</span></label>
                        <input type="number" id="rowDefinitions${index}.order" name="rowDefinitions[${index}].order"
                               class="form-control form-control-sm row-order-input form-input-custom"
                               value="${order}" placeholder="Order" min="0" required/>
                        <div class="text-danger small field-error"></div>
                    </div>
                    <input type="hidden" name="rowDefinitions[${index}].seatTypeId" value="">
                    <div class="remove-btn-container"> <i class="fas fa-times btn-remove-row" title="Remove this row"></i> </div>
                </div>`;
            }

            // Hàm chuyển sang Step 1 (Define Rows)
            function switchToStep1() {
                console.log("Switching to Step 1: Define Rows");
                seatAssignmentSection.slideUp(); // Ẩn phần gán ghế
                finalSaveBtn.fadeOut().prop('disabled', true); // Ẩn và vô hiệu hóa nút Save
                // Bật lại các input ở Step 1
                $('#step1_defineRoom').find('input:not([type=hidden]), select, textarea').prop('readonly', false);
                $('#step1_defineRoom').find('.btn-remove-row').prop('disabled', false).show();
                addRowBtn.prop('disabled', false).show(); // Hiện nút Add row
                generateLayoutBtn.text('Generate Layout & Proceed to Assign Types').removeClass('btn-warning').addClass('btn-info');
                calculateTempCapacityFromInputs(); // Cập nhật capacity từ các input hiện tại
            }

            // Hàm chuyển sang Step 2 (Assign Seat Types)
            function switchToStep2() {
                console.log("Switching to Step 2: Assign Seat Types");
                seatAssignmentSection.slideDown(); // Hiện phần gán ghế
                finalSaveBtn.fadeIn().prop('disabled', false); // Hiện và kích hoạt nút Save
                // Khóa các input ở Step 1
                $('#step1_defineRoom').find('input:not([type=hidden]), select, textarea').prop('readonly', true);
                $('#step1_defineRoom').find('.btn-remove-row').prop('disabled', true).hide();
                addRowBtn.prop('disabled', true).hide(); // Ẩn nút Add row
                generateLayoutBtn.text('Re-generate Layout (Resets Assignments)').removeClass('btn-info').addClass('btn-warning');
                calculateCapacityFromGeneratedLayout(); // Cập nhật capacity từ layout đã tạo
            }


            generateLayoutBtn.on('click', function () {
                console.log("Generate Layout button clicked.");
                if (seatAssignmentSection.is(':visible')) {
                    if (!confirm('Re-generating the layout will reset all current seat assignments. Are you sure?')) {
                        console.log("Layout regeneration cancelled by user.");
                        return; // Ngừng nếu người dùng hủy
                    }
                }
                // Reset dữ liệu gán ghế khi generate layout mới
                currentGeneratedRowDefinitions = [];
                seatAssignments = {};

                let isValidStructure = true;
                let rowIdentifiersSet = new Set();
                let hasDefinedRows = false;

                seatRowsContainer.find('.row-definition').each(function (idx) {
                    hasDefinedRows = true;
                    const $rowDef = $(this);
                    const identifierInput = $rowDef.find('.row-identifier-input');
                    const seatsInput = $rowDef.find('.seats-per-row-input');
                    const orderInput = $rowDef.find('.row-order-input');

                    // Xóa lỗi cũ và reset border
                    identifierInput.closest('.row-identifier-input-container').find('.field-error').text('');
                    seatsInput.closest('.seats-per-row-input-container').find('.field-error').text('');
                    orderInput.closest('.row-order-input-container').find('.field-error').text('');
                    $rowDef.css('border', ''); // Reset border style

                    const identifier = identifierInput.val().trim().toUpperCase();
                    const numberOfSeats = parseInt(seatsInput.val());
                    const order = parseInt(orderInput.val());
                    const existingRowId = $rowDef.find(`input[name^="rowDefinitions"][name$=".id"]`).val(); // Lấy ID đã có

                    let rowIsValid = true;
                    if (!identifier) { rowIsValid = false; isValidStructure = false; identifierInput.closest('.row-identifier-input-container').find('.field-error').text('Row ID is required.'); }
                    else if (rowIdentifiersSet.has(identifier)) { rowIsValid = false; isValidStructure = false; identifierInput.closest('.row-identifier-input-container').find('.field-error').text('Row ID must be unique.'); }
                    else { rowIdentifiersSet.add(identifier); }

                    if (isNaN(numberOfSeats) || numberOfSeats < 1) { rowIsValid = false; isValidStructure = false; seatsInput.closest('.seats-per-row-input-container').find('.field-error').text('Seats must be > 0.'); }
                    if (isNaN(order) || order < 0) { rowIsValid = false; isValidStructure = false; orderInput.closest('.row-order-input-container').find('.field-error').text('Order must be >= 0.'); }

                    if (!rowIsValid) { $rowDef.css('border', '1px solid red'); }
                    else {
                        currentGeneratedRowDefinitions.push({
                            id: existingRowId || null, identifier, numberOfSeats, order
                        });
                    }
                });

                if (!isValidStructure || !hasDefinedRows || (currentGeneratedRowDefinitions.length === 0 && hasDefinedRows)) {
                    const globalErrorContainer = $('#roomForm .global-error');
                    if (globalErrorContainer.length) {
                        globalErrorContainer.html('<p>Please correct errors in row definitions (highlighted in red).</p>').show();
                    } else {
                        alert(!hasDefinedRows ? 'Please define at least one row.' : 'Please correct errors in row definitions.');
                    }
                    switchToStep1(); // Về lại step 1
                    return;
                }
                $('#roomForm .global-error').hide(); // Ẩn lỗi chung nếu thành công

                currentGeneratedRowDefinitions.sort((a, b) => a.order - b.order);
                console.log('Validated and Sorted Row Definitions for Layout:', JSON.stringify(currentGeneratedRowDefinitions));

                renderSeatLayoutPreviewDOM(currentGeneratedRowDefinitions);
                switchToStep2(); // Chuyển sang Step 2
            });

            function renderSeatLayoutPreviewDOM(rowDefinitionsData) {
                seatLayoutPreviewTarget.empty();
                seatLayoutPreviewTarget.parent().find('.screen-preview').hide(); // Ẩn screen mặc định
                noLayoutMessage.show(); // Hiển thị thông báo không có layout mặc định

                let hasRenderedRows = false;
                if (!Array.isArray(rowDefinitionsData) || rowDefinitionsData.length === 0) {
                    console.log("No row definitions provided for rendering layout.");
                    return;
                }

                rowDefinitionsData.forEach(def => {
                    if (def.identifier && def.numberOfSeats > 0) {
                        hasRenderedRows = true;
                        const $seatRowPreview = $('<div>').addClass('seat-row-preview');
                        $seatRowPreview.append($('<div>').addClass('row-identifier-preview').text(def.identifier));
                        const $seatCellsContainer = $('<div>').addClass('d-flex flex-wrap');

                        for (let i = 0; i < def.numberOfSeats; i++) {
                            const seatNumber = i + 1;
                            const seatKey = `${def.identifier}_${seatNumber}`;
                            const $seatCell = $('<div>')
                                .addClass('seat-cell-preview dropzone') // Đảm bảo class 'dropzone'
                                .attr('title', `Seat: ${def.identifier}${seatNumber} (Unassigned)`)
                                .text(seatNumber)
                                .data({
                                    'seat-key': seatKey,
                                    'seat-identifier': def.identifier,
                                    'seat-number': seatNumber,
                                    'seat-number-display': seatNumber
                                });
                            $seatCellsContainer.append($seatCell);
                            // Khởi tạo trạng thái ghế trong seatAssignments là "Unassigned"
                            seatAssignments[seatKey] = {
                                rowIdentifier: def.identifier, seatNumber: seatNumber, typeId: null, typeName: 'Unassigned', color: '#6c757d'
                            };
                        }
                        $seatRowPreview.append($seatCellsContainer);
                        seatLayoutPreviewTarget.append($seatRowPreview);
                    }
                });

                if (hasRenderedRows) {
                    noLayoutMessage.hide();
                    seatLayoutPreviewTarget.parent().find('.screen-preview').show();
                    console.log("Layout rendered. Initializing dropzones for preview elements.");
                    initializeDropzonesForPreview(); // Quan trọng: Khởi tạo dropzone sau khi DOM được tạo
                } else {
                    noLayoutMessage.show();
                    seatLayoutPreviewTarget.parent().find('.screen-preview').hide();
                    console.log("No valid rows to render in preview.");
                }
            }


            function initializeDraggableSeatTypes() {
                // Kiểm tra xem interact đã được tải chưa
                if (typeof interact === 'undefined') {
                    console.error("! InteractJS is NOT loaded when trying to initializeDraggableSeatTypes. Cannot initialize draggable elements.");
                    return;
                }
                interact('.seat-type-palette-form .draggable-seat-type').draggable({
                    inertia: true,
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: 'parent',
                            endOnly: true
                        })
                    ],
                    autoScroll: true,
                    listeners: {
                        start(event) {
                            $(event.target).addClass('dragging');
                            console.log("Drag started on:", $(event.target).data('seat-type-name'));
                        },
                        move: dragMoveListener,
                        end(event) {
                            $(event.target).removeClass('dragging');
                            // Reset position of the dragged element
                            event.target.style.transform = 'translate(0px, 0px)';
                            event.target.setAttribute('data-x', 0);
                            event.target.setAttribute('data-y', 0);
                            console.log("Drag ended for:", $(event.target).data('seat-type-name'));
                        }
                    }
                });
                console.log("Draggable seat types initialized for .seat-type-palette-form .draggable-seat-type");
            }

            function dragMoveListener(event) {
                const target = event.target;
                const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                target.style.transform = `translate(${x}px, ${y}px)`;
                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
            }

            function initializeDropzonesForPreview() {
    if (typeof interact === 'undefined') {
        console.error("! InteractJS is NOT loaded when trying to initializeDropzonesForPreview. Cannot initialize dropzone elements.");
        return;
    }
    const selector = '#seatLayoutPreview .seat-cell-preview.dropzone';
    const elements = $(selector); // jQuery object

    if (elements.length === 0) {
        console.error("InitializeDropzones: No elements found with selector: " + selector + ". Ensure layout is rendered before this call.");
        return; // Không có gì để khởi tạo
    }
    console.log(`InitializeDropzones: Found ${elements.length} elements. Initializing dropzones using selector: ${selector}`);

    // Thử truyền DOM elements thay vì selector string, có thể ổn định hơn
    interact(elements.get()) // elements.get() trả về một mảng các DOM elements
        .dropzone({
        accept: '.draggable-seat-type',
        overlap: 'pointer',

        ondropactivate: function (event) {
            // LOG QUAN TRỌNG: Kiểm tra xem sự kiện này có được kích hoạt không
            console.log("--- ONDROPACTIVATE FIRED on seat: " + $(event.target).data('seat-key') + " --- Related target (draggable): " + $(event.relatedTarget).data('seat-type-name'));
            event.target.classList.add('drop-active');
        },
        ondragenter: function (event) {
            console.log("--- ONDRAGENTER FIRED on seat: " + $(event.target).data('seat-key') + " ---");
            event.target.classList.add('drop-target');
        },
        ondragleave: function (event) {
            console.log("--- ONDRAGLEAVE FIRED on seat: " + $(event.target).data('seat-key') + " ---");
            event.target.classList.remove('drop-target');
        },
        ondrop: function (event) {
            // LOG QUAN TRỌNG: Kiểm tra xem sự kiện này có được kích hoạt không
            console.log("--- ONDROP EVENT FIRED! --- Seat: " + $(event.target).data('seat-key') + ", Type: " + $(event.relatedTarget).data('seat-type-name'));

            const dropzoneSeatDiv = $(event.target);
            const draggableTypeDiv = $(event.relatedTarget);

            const seatKey = dropzoneSeatDiv.data('seat-key');
            const newSeatTypeId = draggableTypeDiv.data('seat-type-id') === "" ? null : draggableTypeDiv.data('seat-type-id');
            const newSeatTypeName = draggableTypeDiv.data('seat-type-name') || 'Unassigned';
            const newSeatTypeColor = draggableTypeDiv.data('seat-type-color') || '#6c757d';

            console.log(`Dropped: typeId=${newSeatTypeId}, typeName=${newSeatTypeName}, color=${newSeatTypeColor} onto seatKey=${seatKey}`);

            // Cập nhật giao diện ghế
            if (newSeatTypeId === null || newSeatTypeName.toLowerCase() === 'unassign') {
                dropzoneSeatDiv.text(dropzoneSeatDiv.data('seat-number-display'));
                dropzoneSeatDiv.css({'background-color': '#6c757d', 'color': 'white'});
                dropzoneSeatDiv.attr('title', `Seat: ${dropzoneSeatDiv.data('seat-identifier')}${dropzoneSeatDiv.data('seat-number-display')} (Unassigned)`);
                seatAssignments[seatKey] = {
                    rowIdentifier: dropzoneSeatDiv.data('seat-identifier'),
                    seatNumber: dropzoneSeatDiv.data('seat-number'),
                    typeId: null, typeName: 'Unassigned', color: '#6c757d'
                };
            } else {
                dropzoneSeatDiv.text(String(newSeatTypeName).substring(0, 1).toUpperCase());
                dropzoneSeatDiv.css('background-color', newSeatTypeColor);
                if (isColorDark(newSeatTypeColor)) { // Gọi hàm JS isColorDark
                    dropzoneSeatDiv.css('color', 'white');
                } else {
                    dropzoneSeatDiv.css('color', 'black');
                }
                dropzoneSeatDiv.attr('title', `Seat: ${dropzoneSeatDiv.data('seat-identifier')}${dropzoneSeatDiv.data('seat-number-display')} (${newSeatTypeName})`);
                seatAssignments[seatKey] = {
                    rowIdentifier: dropzoneSeatDiv.data('seat-identifier'),
                    seatNumber: dropzoneSeatDiv.data('seat-number'),
                    typeId: newSeatTypeId, typeName: newSeatTypeName, color: newSeatTypeColor
                };
            }
            console.log('Updated seatAssignments for key', seatKey, ':', seatAssignments[seatKey]);
            // Cập nhật lại JSON ẩn để submit
            $('#seatAssignmentsField').val(JSON.stringify(Object.values(seatAssignments).map(sa => ({
                rowIdentifier: sa.rowIdentifier,
                seatNumber: sa.seatNumber,
                seatTypeId: (sa.typeId === "" || sa.typeId === undefined) ? null : sa.typeId
            }))));
            console.log("Updated hidden #seatAssignmentsField with new assignments.");
        },
        ondropdeactivate: function (event) {
            console.log("--- ONDROPDEACTIVATE FIRED on seat: " + $(event.target).data('seat-key') + " ---");
            event.target.classList.remove('drop-active', 'drop-target');
        }
    });
    console.log('InteractJS dropzone listeners potentially attached (check individual element logs).');
}


            // Xử lý thêm hàng mới
            addRowBtn.on('click', function () {
                let maxOrder = -1;
                seatRowsContainer.find('.row-order-input').each(function() {
                    const val = parseInt($(this).val());
                    if (!isNaN(val) && val > maxOrder) maxOrder = val;
                });
                const newOrder = seatRowsContainer.find('.row-definition').length === 0 ? 0 : maxOrder + 1;
                const defaultId = String.fromCharCode(65 + nextRowIndex);
                seatRowsContainer.append(createRowDefinitionHTML(nextRowIndex, defaultId, 10, newOrder, '')); // ID rỗng cho hàng mới
                nextRowIndex++;
                console.log(`Added new row definition. nextRowIndex is now ${nextRowIndex}`);
                calculateTempCapacityFromInputs();
            });

            // Xử lý xóa hàng
            seatRowsContainer.on('click', '.btn-remove-row', function () {
                if (confirm('Are you sure?')) {
                    const removedRowIndex = $(this).closest('.row-definition').data('row-index');
                    $(this).closest('.row-definition').remove();
                    console.log(`Removed row definition with data-row-index: ${removedRowIndex}`);
                    calculateTempCapacityFromInputs();
                    // Cần reset layout nếu đang ở step 2 để loại bỏ các ghế của hàng này khỏi preview và seatAssignments
                    if (seatAssignmentSection.is(':visible')) {
                        console.log("Row removed while in Step 2. Forcing layout regeneration.");
                        generateLayoutBtn.click(); // Tự động click generate layout để cập nhật
                    }
                }
            });

            // Hàm tải dữ liệu hiện có cho chế độ chỉnh sửa hoặc thêm hàng mặc định cho form mới
            function loadExistingDataForEdit() {
                const isEditMode = /*[[${roomForm.id != null && roomForm.id != 0}]]*/ false;
                const hasExistingRowsInDOM = seatRowsContainer.find('.row-definition').length > 0;

                if (isEditMode) {
                    console.log("Edit mode detected.");
                    if (hasExistingRowsInDOM && initialSeatAssignmentsJson && initialSeatAssignmentsJson !== "[]") {
                        console.log("Edit mode: Attempting to auto-generate layout and apply assignments.");
                        // Sắp xếp initialRowDefinitionsFromServer trước khi dùng
                        currentGeneratedRowDefinitions = initialRowDefinitionsFromServer.sort((a,b) => a.order - b.order).map(def => ({
                            id: def.id, identifier: def.identifier, numberOfSeats: def.numberOfSeats, order: def.order,
                            // seatTypeIdFromDTO này không dùng trực tiếp trong renderSeatLayoutPreviewDOM,
                            // mà dùng để khởi tạo seatAssignments ban đầu nếu cần.
                            // Tuy nhiên, logic hiện tại gán typeId cho từng ghế từ initialSeatAssignmentsJson
                            seatTypeIdFromDTO: (def.seatTypeId === "" || def.seatTypeId === undefined || def.seatTypeId === null) ? null : def.seatTypeId
                        }));

                        renderSeatLayoutPreviewDOM(currentGeneratedRowDefinitions);

                        try {
                            const assignmentsFromServer = JSON.parse(initialSeatAssignmentsJson);
                            console.log("Applying initial seat assignments from server JSON:", assignmentsFromServer);
                            assignmentsFromServer.forEach(rowAssignment => {
                                if (rowAssignment.seats) {
                                    rowAssignment.seats.forEach(seatInAssign => {
                                        const seatKey = `${rowAssignment.rowIdentifier}_${seatInAssign.seatNumber}`;
                                        if (seatAssignments[seatKey]) { // Đảm bảo ghế tồn tại trong layout hiện tại
                                            const seatType = availableSeatTypes.find(st => st.id == seatInAssign.seatTypeId); // So sánh giá trị, không kiểu
                                            const typeIdToAssign = (seatInAssign.seatTypeId === "" || seatInAssign.seatTypeId === undefined || seatInAssign.seatTypeId === null) ? null : seatInAssign.seatTypeId;

                                            seatAssignments[seatKey].typeId = typeIdToAssign;
                                            seatAssignments[seatKey].typeName = seatType ? seatType.name : (typeIdToAssign ? 'Unknown Type' : 'Unassigned');
                                            seatAssignments[seatKey].color = seatType ? seatType.color : '#6c757d';

                                            const $seatCell = $(`.seat-cell-preview[data-seat-key="${seatKey}"]`);
                                            if ($seatCell.length) {
                                                if (typeIdToAssign) {
                                                    $seatCell.text(String(seatAssignments[seatKey].typeName).substring(0,1).toUpperCase()).css('background-color', seatAssignments[seatKey].color);
                                                    if (isColorDark(seatAssignments[seatKey].color)) $seatCell.css('color', 'white'); else $seatCell.css('color', 'black');
                                                } else { // Unassign
                                                    $seatCell.text($seatCell.data('seat-number-display')).css({'background-color': '#6c757d', 'color': 'white'});
                                                }
                                                $seatCell.attr('title', `Seat: ${$seatCell.data('seat-identifier')}${$seatCell.data('seat-number-display')} (${seatAssignments[seatKey].typeName})`);
                                            }
                                        }
                                    });
                                }
                            });
                            console.log("Applied initial seat assignments from server to UI. Current seatAssignments object:", seatAssignments);
                        } catch (e) {
                            console.error("Error parsing/applying initialSeatAssignmentsJson:", e);
                            // Nếu có lỗi, quay về Step 1
                            switchToStep1();
                            return;
                        }
                        switchToStep2(); // Chuyển sang Step 2 sau khi load dữ liệu
                    } else if (!hasExistingRowsInDOM && initialRowDefinitionsFromServer && initialRowDefinitionsFromServer.length > 0) {
                        // Trường hợp edit form nhưng Thymeleaf không render được row nào (có thể do lỗi backend hoặc Thymeleaf)
                        // Lúc này, cần tự động render lại các row từ JS nếu có dữ liệu từ server
                        console.warn("Edit mode detected, but no rows rendered by Thymeleaf. Rendering from initialRowDefinitionsFromServer.");
                        initialRowDefinitionsFromServer.forEach((def, index) => {
                             seatRowsContainer.append(createRowDefinitionHTML(index, def.identifier, def.numberOfSeats, def.order, def.id));
                        });
                        nextRowIndex = initialRowDefinitionsFromServer.length; // Cập nhật nextRowIndex
                        switchToStep1();
                    } else {
                        console.log("Edit mode, but no initial data for layout or no rows defined, defaulting to Step 1.");
                        // Nếu là form edit nhưng không có hàng nào cả, thì thêm 1 hàng mặc định
                        if (!hasExistingRowsInDOM) {
                            addRowBtn.click();
                        }
                        switchToStep1();
                    }
                } else {
                    console.log("Add New mode detected.");
                    // Nếu là form Add New và chưa có hàng nào, thêm một hàng mặc định
                    if (!hasExistingRowsInDOM) {
                        console.log("Add New form and no rows present, adding one default row.");
                        addRowBtn.click();
                    }
                    switchToStep1(); // Luôn bắt đầu ở Step 1 cho form Add New
                }
                calculateTempCapacityFromInputs(); // Cập nhật capacity ban đầu
            }

            // --- INITIALIZATION CALLS ---
            initializeDraggableSeatTypes();
            // Gọi loadExistingDataForEdit sau khi tất cả các hàm đã được định nghĩa
            loadExistingDataForEdit();

            // Logic submit form
            $('#roomForm').on('submit', function(e) {
                // Kiểm tra lại nếu form chưa ở Step 2
                if (seatAssignmentSection.is(':hidden') || finalSaveBtn.is(':hidden') || finalSaveBtn.prop('disabled')) {
                    alert('Please generate the layout (and optionally assign seat types) before saving.');
                    e.preventDefault();
                    return false;
                }

                // Cập nhật các input ẩn .seatTypeId trong các .row-definition
                // (Mặc dù hiện tại UI không cho phép client thay đổi trực tiếp seatTypeId của RowDefinitionDTO)
                // Các trường này có thể dùng để lưu trữ seatTypeId mặc định cho cả hàng nếu có
                currentGeneratedRowDefinitions.forEach((def) => {
                    const $rowDiv = seatRowsContainer.find(`.row-definition`).filter(function() {
                        return $(this).find('.row-identifier-input').val().trim().toUpperCase() === def.identifier &&
                               parseInt($(this).find('.row-order-input').val()) === def.order;
                    }).first();

                    if ($rowDiv.length) {
                        const originalIndex = $rowDiv.data('row-index');
                        // Gán seatTypeId mặc định cho rowDefinition nếu cần, ví dụ từ một seat assignment phổ biến nhất trong hàng đó
                        // Hiện tại chúng ta không có logic này, nên có thể để trống hoặc null
                        $rowDiv.find(`input[name="rowDefinitions[${originalIndex}].seatTypeId"]`).val('');
                    }
                });

                // Chuẩn bị dữ liệu seatAssignments để gửi lên server
                const finalAssignments = Object.values(seatAssignments).map(sa => ({
                    rowIdentifier: sa.rowIdentifier,
                    seatNumber: sa.seatNumber,
                    // Đảm bảo typeId là null nếu không có, hoặc giá trị đã gán
                    seatTypeId: (sa.typeId === "" || sa.typeId === undefined) ? null : sa.typeId
                }));

                // Gán JSON vào input ẩn để gửi đi
                $('#seatAssignmentsField').val(JSON.stringify(finalAssignments));

                console.log("Submitting form...");
                console.log("Row Definitions (from form inputs, submitted via Spring Data Binding):", currentGeneratedRowDefinitions);
                console.log("Seat Assignments JSON (to be submitted via hidden field):", JSON.stringify(finalAssignments));
                // Form sẽ submit bình thường sau khi dòng này
            });
        });
        /*]]>*/
    </script>
</body>
</html>

